\rednote{Give some context, i.e. important theorem in the foundations of
algebraic geometry, useful for X, Y, Z, ...}

\rednote{Discuss slight apparent mismatch to classical version regarding
finiteness hypotheses}

\rednote{Discuss relative version}

The following observation is classically a fundamental result on quasi-compact
and quasi-separated schemes.

\begin{lemma}\label{enough-functions-affine}
  Let~$X$ be a scheme. Let global functions~$f_1,\ldots,f_n : X \to R$ be given
  such that all the open subschemes~$D(f_i)$ are affine and such that~$X =
  D(f_1) \cup \ldots \cup D(f_n)$. Then the canonical map~$X \to \Spec(R^X)$ is
  an open immersion. If furthermore the functions~$f_i$ generate the unit ideal
  in the ring~$R^X$, this map is bijective.
\end{lemma}

\begin{proof}
  The classical proof, for instance as collected in the Stacks
  Project~\cite{stacks}[Tag~01QF], carries over to our setting. We spell out
  some details.

  We first show that the canonical map is injective, hence let~$p,q : X$ be such
  that~$f(p) = f(q)$ for all~$f \in R^X$. Because the~$D(f_i)$ cover~$X$, one
  of the numbers~$f_i(p)$ is invertible. Hence~$p$ and~$q$ belong to the same
  open~$D(f_i)$. Because~$D(f_i)$ is affine by assumption, we only need to
  verify that~$g(p) = g(q)$ for all~$g \in R^{D(f_i)}$ in order to conclude
  that~$p = q$. This follows from the fact~$R^{D(f_i)} = (R^X)[f_i^{-1}]$,
  whose classical proof (as for instance reproduced
  in~\cite{liu}[Proposition~2.3.12]) just uses a bit of homological algebra and
  carries over to our setting verbatim.

  One can check that the image of the canonical map is~$D_{X'}(f_1) \cup \cdots
  \cup D_{X'}(f_n)$, where~$D_{X'}(f_i)$ refers to the standard open of~$X'
  \vcentcolon= \Spec(R^X)$ associated to~$f_i : R^X$. From this observation the
  remaining claims follows.
\end{proof}

\rednote{Decide on notation for constant bundle}

\begin{lemma}\label{serre-workhorse}
  Let~$X$ be a scheme. Assume that~$H^1(X, E) = 0$ for all wqc bundles of ideals~$E$
  on~$X$. Let~$X = U \cup V$ be an open covering with~$U$ affine. Then there
  merely is a function~$f : X \to R$ such that~$D(f) \subseteq U$ and such
  that~$X = D(f) \cup V$.
\end{lemma}

\begin{proof}
  As with any open subset of an affine scheme, the open subset~$U \cap V$
  of~$U$ is the complement of some closed subset~$K \subseteq U$:
  If~$U \cap V = D(g_1) \cup \cdots \cup D(g_m)$ for some
  functions~$g_1,\ldots,g_m : U \to R$, we may set~$K = V(g_1,\ldots,g_m)$;
  then~$U \cap V = U \setminus K$. Let~$i : K \to X$ be the inclusion map.

  Let~$J$ be the subbundle of the constant bundle~$\underline{R}$ with
  fibers~$J_x = \{ a : R \,|\, a \in R^\times \Rightarrow x \in U \}$.
  Global sections of~$J$ are global functions~$f : X \to R$ such that~$D(f)
  \subseteq U$. The bundle~$J$ is wqc by~\cref{XXX}.

  The fibers of the pushforward bundle~$i_*\underline{R}$ have the explicit
  description~$(i_*\underline{R})_x = R^{\llbracket x \in K \rrbracket}$; a
  global section of this bundle is a global function~$K \to R$.

  We have a canonical morphism~$\varphi : J \to i_*\underline{R}$, given on
  fibers by mapping a number~$a : J_x$ to the constant map with value~$a$. This
  morphism is surjective on fibers: Let~$x : X$. Then~$x \in U$ or~$x \in V$.
  In the latter case, we have~$x \not\in K$ so~$R^{\llbracket x \in K
  \rrbracket} = 0$. In the former case, $R^{\llbracket x \in K \rrbracket}$ is
  a quotient of~$R$ because the truth value of~$x \in K$ is closed (if~$x \in K
  \Leftrightarrow a_1 = \ldots = a_m = 0$, then~$R^{\llbracket x \in K
  \rrbracket} = R/(a_1,\ldots,a_m)$) and~$\varphi_x$ is the canonical
  surjective quotient map.

  Because the first cohomology of the kernel of~$\varphi$ vanishes, the
  morphism~$\varphi$ is also surjective on global sections. In particular, the
  global function~$1 : K \to R$ has a preimage~$f$. By construction of~$J$,
  we have~$D(f) \subseteq U$.

  It remains to prove~$X = D(f) \cup V$. Let~$x : X$. Then~$x \in U$ or~$x \in V$.
  In the latter case, we trivially have~$x \in D(f) \cup V$. In the former
  case, writing~$x \in V \Leftrightarrow a_1 = \ldots = a_m = 0$ again,
  we have~$\neg(f(x) = 0 \wedge a_1 = 0 \wedge \cdots \wedge a_m = 0$ by~$U
  \cap V = U \setminus K$. By the generalized field property, one of the
  numbers~$f(x), a_1, \ldots, a_m$ is invertible, so~$x \in D(f)$ or~$x \in V$.
\end{proof}

\begin{proposition}\label{serre-prop}
  Let~$X$ be a scheme. If~$H^1(X, E) = 0$ for all wqc bundles of ideals~$E$ on~$X$, then
  there exist global functions as in~\cref{enough-functions-affine}.
\end{proposition}

\begin{proof}
  Because~$X$ is a scheme, there is a finite open affine covering~$X = U_1 \cup
  \cdots \cup U_n$. By applying~\cref{serre-workhorse} to the binary
  coverings~$U_1 \cup (U_2 \cup \cdots \cup U_n)$, $U_2 \cup (U_1 \cup U_3 \cup
  \ldots \cup U_n)$ and so on, we may assume that each open~$U_i$ is of the
  form~$U_i = D(f_i)$ for some global function~$f_i : X \to R$.

  Because~$X = U_1 \cup \dots \cup U_n$, for every point~$x : X$ we trivially
  have that the numbers~$f_1(x),\ldots,f_n(x)$ generate the unit ideal in~$R$.
  In other words, the bundle morphism~$\underline{R}^n \to \underline{R}$ given by
  the matrix~$(f_1 \cdots f_n)$ is surjective at each fiber. The
  functions~$f_1,\ldots,f_n$ generate the unit ideal in~$R^X$ iff this morphism
  is also surjective on global sections. Hence we need to verify that its
  kernel has vanishing first cohomology.

  If the assumption would have been that all wqc bundles of modules have
  vanishing first cohomology, this task would be trivial. However, the
  kernel~$K$ is a subbundle of~$\underline{R}^n$ and hence not a bundle of
  ideals of~$\underline{R}$. But~$K$ is filtered by its subbundles~$K_j = (\{
  (a_1,\ldots,a_n) : K_x \,|\, \text{$a_i = 0$ for~$i > j$} \})_{x:X}$ for~$j =
  0,\ldots,n$, and each quotient~$K_{j+1}/K_j$ has vanishing first cohomology
  as it is isomorphic to a wqc bundle of ideals of~$\underline{R}$ (by
  projecting to the~$j$-th coordinate).
\end{proof}

\begin{theorem}
  Let~$X$ be a scheme. If~$H^1(X, E) = 0$ for all wqc bundles of ideals~$E$
  on~$X$, then~$X$ is affine.
\end{theorem}

\begin{proof}
  Immediate from~\cref{serre-prop} and~\cref{enough-functions-affine}.
\end{proof}
