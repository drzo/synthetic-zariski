In non-synthetic algebraic geometry,
the structure sheaf~$\mathcal{O}_X$ is part of the data constituting a scheme~$X$.
In our internal setting,
the scheme $X$ is just a set without any additional data,
but when we want to consider the structure sheaf as an object in its own right,
then we can represent it by the trivial bundle
that assings to every point $x : X$ the set $R$.
Indeed, for an affine scheme $X = \Spec A$,
taking the sections of this bundle over a basic open $D(f) \subseteq X$
\[ \prod_{x : D(f)} R = (D(f) \to R) = A[f^{-1}] \]
yields the localizations of the ring $A$
expected from the structure sheaf $\mathcal{O}_X$.
More generally,
instead of sheaves of abelian groups, $\mathcal{O}_X$-modules, etc.,
we will consider bundels of abelian groups, $R$-modules, etc.,
in the form of maps from $X$ to the respective type of algebraic structures.

\subsection{Quasi-coherent bundles}

This subsection is still experimental.

Sometimes we want to ``apply'' a bundle to a subtype,
like sheaves can be evaluated on open subspaces
and introduce the common notation ``$M(U)$'' for that below.
It is, however, not justified to expect, that this application
and the corresponding theory of ``sheaves'' is ``the same'' as the external one,
since the definition below, uses the internal hom ``$\prod$''
-- where the corresponding external construction, would be the set of continuous sections of a bundle.

\begin{definition}
  \index{$M(U)$}
  Let $X$ be a type and $M:X\to \Mod{R}$ a dependent module.
  Let $U\subseteq X$ be any subtype.
  \begin{enumerate}[(a)]
  \item We write:
    \[
      M(U)\colonequiv \prod_{x:U}M_x
      \rlap{.}
    \]
  \item With pointwise structure, $U\to R$ is an $R$-algebra
    and $M(U)$ is a $(U\to R)$-module.
  \end{enumerate}
\end{definition}

Somewhat surprisingly, localization of modules $M(U)$
can be done pointwise:

\begin{lemma}[using \axiomref{Z-choice}]%
  \label{module-bundle-localization-pointwise}
  Let $X$ be a scheme and $M:X\to \Mod{R}$ a dependent module.
  Let $U=\Spec A\subseteq X$ be open affine.
  Let $f:A$.
  \begin{enumerate}[(a)]
  \item There is a morphism
    \[
      M(U)_f\to \prod_{x:U}(M_x)_{f(x)}
      \rlap{.}
    \]
  \item Let $g,h:M(U)_f$. Then $g=h$ if and only if
    \[
      \prod_{x:U}g(x)=_{(M_x)_{f(x)}}h(x)
      \rlap{.}
    \]
  \item The morphism in (a) is an equivalence, i.e.
    \[
      M(U)_f=\prod_{x:U}(M_x)_{f(x)}
      \rlap{.}
    \]
  \end{enumerate}
\end{lemma}

\begin{proof}
  \begin{enumerate}[(a)]
  \item We have to show, that the map
    \[
      \frac{m}{f^k}\mapsto\left(x\mapsto \frac{m(x)}{f(x)^k}\right)
    \]
    is well-defined. So let $\frac{m}{f^k}=\frac{m'}{f^{k'}}$,
    i.e. let there be an $l:\N$ such that $f^l(mf^{k'}-m'f^k)=0$.
    But we can chose $l:\N$ for each $x:U$ and apply the equation to each $x:U$.
  \item The forward direction was treated in (a).
    So let $g,h:M(U)_f$ such that $p:\prod_{x:U}g(x)={(M_x)_{f(x)}}h(x)$.
    Let $m_g,m_h:(x:U)\to M_x$ and $k_g,k_h:\N$ such that
    \[
      g=\frac{m_g}{f^{k_g}}\text{ and }h=\frac{m_h}{f^{k_h}}
      \rlap{.}
    \]
    From $p$ we know $\prod_{x:U}\exists_{k_x:\N}f(x)^{k_x}(m_g(x)f(x)^{k_h}-m_h(x)f(x)^{k_g})=0$.
    By \axiomref{Z-choice} we have coprime $a_1,\dots,a_l:A$ such that for each $i$
    we can replace $k_x$ by some $k_i$ in the equation above.
    There are only finitely many $k_i$, so $k\colonequiv k_1\cdot\dots\cdot k_l$ has the property
    \[
      \prod_{x:U}f(x)^{k}(m_g(x)f(x)^{k_h}-m_h(x)f(x)^{k_g})=0
    \]
    -- which shows $g=h$.
  \item We will construct an inverse to the map in (a).
    So let $\varphi:\prod_{x:U}(M_x)_{f(x)}$ and
    \[
      \tilde{\varphi}:
      \prod_{x:U}
      \exists_{k_x:\N,m_x:M_x}
      \varphi(x)=\frac{m_x}{f(x)^{k_x}}
      \rlap{.}
    \]
    By \axiomref{Z-choice},
    we get coprime $a_1,\dots,a_l:A$, $k:\N$, $m_i:D(a_i)\to M_x$ such that for each $i$
    \[
      \prod_{x:D(a_i)}\varphi(x)=\frac{m_i(x)}{f(x)^{k}}
      \rlap{.}
    \]
    The problem is now to construct a global $m:(x:U)\to M_x$ from the $m_i$.
    We use \cref{kraus-glueing} of $\tilde{m}_i$, which we will construct in the following to achieve that.
    We have
    \[
        \prod_{x:D(a_ia_j)}\frac{m_i(x)}{f(x)^k}=\varphi(x)=\frac{m_j(x)}{f(x)^k}
    \]
    meaning there is pointwise an exponent $t_x:\N$, such that $f(x)^{t_x+k}m_i(x)=f(x)^{t_x+k}m_j(x)$.
    By \axiomref{Z-choice}, we can find a maximal $t:\N$ with this property and define
    \[
      \tilde{m}_i\colonequiv x \mapsto f(x)^{t+k}m_i(x)
      \rlap{.}
    \]
    Then we have $\tilde{m}_i(x)=\tilde{m}_j(x)$ on all intersections $D(a_i)\cap D(a_j)$,
    which is needed to get the global $m:(x:U)\to M_x$ from \cref{kraus-glueing}.
    Since $\varphi(x)=\frac{f(x)^{t+k}m_i(x)}{f(x)^{t+2k}}=\frac{\tilde{m}_i(x)}{f(x)^{t+2k}}$ for all $x$ and $i$,
    we have found a preimage of $\varphi$ in $M(U)_f$.

    Therefore, the map in (a) is surjective.
    By (b) it is injective, so we have an equivalence of sets.
  \end{enumerate}
\end{proof}

We will need the following algebraic lemma:

\begin{lemma}[using \axiomref{sqc}]%
  \label{localization-to-module-if-non-zero}
  Let $M$ be an $R$-module and $f:R$,
  then there is an $R$-linear map
  \[
    M_f\to M^{f\neq 0}
    \rlap{.}
  \]
\end{lemma}

\begin{proof}
  Let $x\equiv \frac{m}{f^k}:M_f$ and $p:f\neq 0$.
  Then $f$ is invertible, so we have
  \[
    x\equiv \frac{m}{f^k}=\frac{f^{-k}m}{1}
  \]
  and mapping $x$ to $f^{-k}m$ is an $R$-linear map.
  
\end{proof}

\begin{lemma}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  \label{localization-to-restriction}                    
  Let $X$ be a scheme, $M:X\to\Mod{R}$, $U=\Spec A\subseteq X$ open and $f:A$.
  Then there is an $R$-linear map
  \[
    M(U)_f \to M(D(f)) 
    \rlap{.}
  \]
\end{lemma}

\begin{proof}
  Combining \cref{module-bundle-localization-pointwise}
  and pointwise application of \cref{localization-to-module-if-non-zero} we get
  \[
    M(U)_f=\left(\prod_{x:U}(M_x)_{f(x)}\right)\to \left(\prod_{x:U}(M_x)^{f(x)\neq 0}\right)
    =\left(\prod_{x:D(f)}M_x\right)
    =M(D(f))
  \]
\end{proof}

The following is an experimental definition,
which might be suitable
to mimic the external notion of quasi-coherent $\mathcal O_X$-module sheaves.

\begin{definition}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  Let $X$ be a scheme.
  A dependent module $M:X\to \Mod{R}$ is \notion{quasi-coherent},
  if for all $x:X$ and $f:R$, the canonical map from \cref{localization-to-module-if-non-zero} is an equivalence:
    \[
      (M_x)_f\simeq M_x^{f\neq 0}
      \rlap{.}
    \]
\end{definition}

An immediate consequence is, that
quasi coherent dependent modules have
the property that ``restricting is the same as localizing'':

\begin{lemma}
  Let $X$ be a scheme and $M:X\to \Mod{R}$ quasi-coherent,
  then for all open affine $U=\Spec A\subseteq X$ and $f:A$
  the canonical morphism
  \[
    M(U)_f\to M(D(f))
  \]
  is an equivalence.
\end{lemma}

\begin{proof}
  By construction of the canonical map from \cref{localization-to-restriction}.
\end{proof}

Quasi-coherent dependent modules turn out to have very good properties,
which are to be expected from what is known about their external counterparts.
We will show below, that quasi coherence is preserved by the following constructions:

\begin{definition}
  \label{pullback-push-forward}
  Let $X,Y$ be types and $f:X\to Y$ be a map.
  \begin{enumerate}[(a)]
  \item \index{$f^*M$} For any dependent module $N:Y\to\Mod{R}$,
    the \notion{pullback} or \notion{inverse image} is the dependent module
    \[
      f^*N\colonequiv (x:X) \mapsto M_{f(x)}\rlap{.}
    \]
  \item \index{$f_*M$} For any dependent module $M:X\to\Mod{R}$,
    the \notion{push-forward} or \notion{direct image} is the dependent module
    \[
      f_*M\colonequiv (y:Y) \mapsto \prod_{x:\fib_f(y)}M_{\pi_1(x)}\rlap{.}
    \]
  \end{enumerate}
\end{definition}

\begin{theorem}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  \label{pullback-push-forward-qcoh}
  Let $X,Y$ be schemes and $f:X\to Y$ be a map.
  \begin{enumerate}[(a)]
  \item For any quasi-coherent dependent module $N:Y\to\Mod{R}$,
    the inverse image $f^*N$ is quasi-coherent.
  \item For any dependent module $M:X\to\Mod{R}$,
    the direct image $f_*M$ is quasi-coherent.
  \end{enumerate}
\end{theorem}

\begin{proof}
  \begin{enumerate}[(a)]
  \item There is nothing to do, when we use the pointwise definition of quasi-coherence. 
  \item TODO, Ideas:

    Show that the dependent product of modules is a module.
    Show that this product preserves qcoh, if the index type is a scheme.
    Use that the fiber of a scheme morphism is a scheme.
  \end{enumerate}
\end{proof}

\subsection{Finitely presented bundles}

We now investigate the relationship between bundles of $R$-modules on $X = \Spec A$
and $A$-modules.

\begin{proposition}
  Let $A$ be a finitely presented $R$-algebra.
  There is an adjunction
  \[ \begin{tikzcd}[row sep=tiny]
    M \ar[r, mapsto] & {(M \otimes x)}_{x : \Spec A} \\
    \Mod{A} \ar[r, shift left=2] \ar[r, phantom, "\rotatebox{90}{$\vdash$}"] &
    \Mod{R}^{\Spec A} \ar[l, shift left=2] \\
    \prod_{x : \Spec A} N_x & N \ar[l, mapsto]
  \end{tikzcd} \]
  between the category of $A$-modules
  and the category of bundles of $R$-modules on $\Spec A$.
\end{proposition}

\begin{theorem}%
  \label{fp-module}
  Let $X=\Spec(A)$ be affine and
  let a bundle of finitely presented $R$-modules $M : X\to \fpMod{R}$ be given.
  Then the $A$-module
  \[ \tilde{M}\coloneqq\prod_{x:X}M_x \]
  is finitely presented and for any $x:X$ the $R$-module $\tilde{M}\otimes_A R$ is $M_x$.
  Under this correspondence, localizing $\tilde{M}$ at $f:A$ corresponds to restricting $M$ to $D(f)$.
\end{theorem}

\subsection{Cohomology on affine schemes}

\begin{definition}%
  \label{torsor}
  Let $X$ be a type and $A:X\to \AbGroup$ a map to the type of abelian groups.
  For $x:X$ let $T_x$ be a set with an $A_x$ action.
  \begin{enumerate}[(a)]
  \item $T$ is an \notion{$A$-pseudotorsor}, if the action is free and transitive for all $x:X$.
  \item $T$ is an \notion{$A$-torsor}, if it is an $A$-pseudotorsor and
    \[ \prod_{x:X} \| T_x \| \rlap{.}\]
  \item We write $\Tors{A}(X)$ for the type of $A$-torsors on $X$.
  \end{enumerate}
\end{definition}

Torsors on a point are a concrete implementaion of first deloopings:

\begin{definition}
  \label{delooping}
  Let $n:\N$.
  A $n$-th \notion{delooping}\index{$K(A,n)$} of an abelian group $A$,
  is a pointed, $(n-1)$-connected, $n$-truncated type $K(A,n)$,
  such that $\Omega^nK(A,n)=_{\AbGroup}A$.
\end{definition}

For any abelian group and any $n$, a delooping $K(A,n)$ exists by \cite{licata-finster}.
Deloopings can be used to represent cohomology groups by mapping spaces.
This is usually done in homotopy type theory to study higher inductive types, such as spheres and CW-complexes,
but the same approach works for internally representing sheaf cohomology,
which is the intent of the following definition:

\begin{definition}
  \label{cohomology}
  Let $X$ be a type and $\mathcal F:X\to\AbGroup$ a dependent abelian group.
  The $k$-th cohomology group of $X$ with coefficients in $\mathcal F$ is
  \[
    H^k(X,\mathcal F)\colonequiv \left\|\prod_{x:X}K(\mathcal F,k)\right\|_0\rlap{.}
  \]
\end{definition}


The following is an explicit formulation of the fact, that the Čech-Complex for an
$\mathcal{O}_X$-module sheaf on $X=\Spec(A)$ given by an $A$-module $M$ is exact in degree 1.
\begin{lemma}%
  \label{H1-algebra}
  Let $M$ be a module over a commutative ring $A$, $F_1,\dots,F_l$ a coprime system on $A$
  and for $i,j\in\{1,\dots,l\}$, let $s_{ij} : F_i^{-1} F_j^{-1} M$ such that:
  \[ s_{jk}-s_{ik}+s_{ij}=0 \rlap{.}\]
  Then there are $u_i:F_i^{-1}M$ such that $s_{ij}=u_j - u_i$.
\end{lemma}

\begin{proof}
  Let $s_{ij}=\frac{m_{ij}}{f_i f_j}$ with $m_{ij}:M$, $f_i:F_i$ and $f_j:F_j$ such that:
  \[ f_i\cdot m_{jk}-f_j\cdot m_{ik}+f_k\cdot m_{ij}=0 \rlap{.}\]
  Let $r_i$ such that $\sum r_i f_i =1$.
  Then for
  \[ u_i \coloneqq -\sum_{k=1}^l\frac{r_k}{f_i}m_{ik} \]
  we have:
  \begin{align*}
      u_j-u_i &= -\sum_{k=1}^l\frac{r_k}{f_j}m_{jk} + \sum_{k=1}^l\frac{r_k}{f_i}m_{ik} \\
              &= -\sum_{k=1}^l\frac{r_k}{f_j f_i}f_i m_{jk} + \sum_{k=1}^l\frac{r_k}{f_i f_j} f_j m_{ik} \\
              &= \sum_{k=1}^l\frac{r_k}{f_j f_i}(-f_i m_{jk} + f_j m_{ik}) \\
              &= \sum_{k=1}^l\frac{r_k}{f_j f_i}f_k m_{ij} \\
              &= \frac{m_{ij}}{f_i f_j}
  \end{align*}
  \ %
\end{proof}

\begin{theorem}[using \axiomref{Z-choice}]%
  \label{H1-fp-module-affine-trivial}
  For any affine scheme $X=\Spec(A)$ and coefficients $M: X\to \fpMod{R}$, we have
  \[ H^1(X,M)=0 \rlap{.} \]
\end{theorem}
\begin{proof}
  We need to show, that any $M$-torsor $T$ on $X$ is merely equal to the trivial torsor $M$,
  or equivalently show the existence of a section of $T$.
  We have
  \[ \prod_{x:X}\| T_x \|\]
  and therefore, by (\axiomref{Z-choice}),
  there merely are $f_1,\dots,f_l:A$,
  such that the $U_i\coloneqq \Spec(A_{f_i})$ cover $X$ and
  there are local sections
  \[ s_i:\prod_{x:U_i}T_x\]
  of $T$. Our goal is to construct a matching family from the $s_i$.
  On intersections, let $t_{ij}\coloneqq s_i-s_j$ be the difference, so $t_{ij}:(x : U_i\cap U_j) \to M_x$.
  By \cref{fp-module} equivalently, we have $t_{ij}:\tilde{M}_{f_i f_j}$.
  Since the $t_{ij}$ were defined as differences,
  the condition in \cref{H1-algebra} is satisfied and we get
  $u_i:\tilde{M}_{f_i}$, such that $t_{ij}=u_i-u_j$.
  So we merely have a matching family $\tilde{s}_i\coloneqq s_i-u_i$ and therefore, using Lemma \ref{kraus-glueing} merely a section of $T$.
\end{proof}

A similar result is provable for $H^2(X,M)$ and we expect that $H^n(X,M)$ holds, at least for any external $n$.

\subsection{Čech-Cohomology}

In this section, let $X$ be a type, $U_1,\dots,U_n\subseteq X$ open subtypes that cover $X$
and $\mathcal F:X\to \AbGroup$ a dependent abelian group on $X$.
We start by repeating the classical definition of Chech-Cohomology groups for a given cover.

\begin{definition}%
  \label{chech-complex}
  \begin{enumerate}[(a)]
  \item \index{$\mathcal F(U)$} For open $U\subseteq X$, we use the notation
    \[
      \mathcal F(U)\colonequiv \prod_{x:U}\mathcal F_x\rlap{.}
    \]
  \item For $s:\mathcal F(U)$ and open $V\subseteq U$ we use the notation $s\colonequiv s_{|V} \colonequiv (x:V)\mapsto s_x$.
  \item \index{$U_{i_1\dots i_l}$}For a selection of indices $i_1,...,i_l:\{1,\dots,n\}$, we use the notation
    \[
      U_{i_1\dots i_l}\colonequiv U_{i_1}\cap\dots\cap U_{i_l}\rlap{.}
    \]
  \item For a list of indices $i_1,\dots,i_l$, let $i_1,\dots,\hat{i_t},\dots,i_l$ be the same list with the $t$-th element removed.
  \item For $k:\Z$, the $k$-th \notion{Čech-boundary operator}\index{$\partial^k$} is the homomorphism
    \[
      \partial^k:\bigoplus_{i_0,\dots,i_k}\mathcal F(U_{i_0\dots i_k})\to \bigoplus_{i_0,\dots,i_{k+1}}\mathcal F(U_{i_0\dots i_{k+1}})
    \]
    given by $\partial^k(s)\colonequiv (l_0,\dots,l_{k+1}) \mapsto \sum_{j=0}^k (-1)^j s_{l_0,\dots,\hat{l_j},\dots,l_k|U_{l_0,\dots,l_{k+1}}}$.
  \item The $k$-th \notion{Čech-Cohomology group} for the cover $U_1,\dots,U_n$ with coefficients in $\mathcal F$ is
    \[
      \check{H}^k(\{U\},\mathcal F)\colonequiv \ker\partial^{k} / \im(\partial^{k-1})\rlap{.}
    \]
  \end{enumerate}
\end{definition}

\begin{definition}
  The cover $U_1,\dots,U_n$ is called \notion{acyclic} for $\mathcal F$,
  if for all $k:\N$ and $i_0,\dots,i_k$, we have that the higher (non Čech) cohomology groups are trivial:
  \[
    \forall l>0. H^l(U_{i_0,\dots,i_k},\mathcal F)=0\rlap{.}
  \]
\end{definition}

\begin{example}
  If $X$ is a scheme, $U_1,\dots,U_n$ a cover by affine open subtypes and $\mathcal F$ pointwise a finitely presented $R$-module,
  then $U_1,\dots,U_n$ is acyclic for $\mathcal F$ by \cref{H1-fp-module-affine-trivial}.
\end{example}

\begin{theorem}[using \axiomref{Z-choice}]%
  If $U_1,\dots,U_n$ is an acyclic cover for $\mathcal F$, then
  \[
    \check{H}^1(\{U\},\mathcal F)=H^1(X,\mathcal F)\rlap{.}
  \]
\end{theorem}

\begin{proof}
  Let $\pi$ be the projection map
  \[
    \pi :
    \left(
      \sum_{T:\Tors{\mathcal F}(X)}\prod_{i}\prod_{x:U_i}T_x
    \right)
    \to \Tors{\mathcal F}(X)\rlap{.}
  \]
  Let us abbreviate the left hand side with $T(\mathcal F,U)$.
  Since the cover is acyclic, $\pi$ is surjective.
  There is a map $\iota$ into the kernel of $\partial^1$ (\cref{chech-complex} (e)):
  \[
    \iota \colonequiv
    (T,t) \mapsto (i,j\mapsto t_i - t_j) :
    T(\mathcal F,U)
    \to
    \ker(\partial^1)
    \subseteq
    \bigoplus_{i,j}\mathcal F(U_{ij})\rlap{.}
  \]
  We will now show, that $\iota$ is an embedding and therefore also, that its domain is a set.
  Let $(T,t),(T',t'):T(\mathcal F,U)$ such that $\iota((T,t))=\iota((T',t'))$,
  i.e. for all $i,j$ we have $t_i-t_j=t'_i-t'_j$.
  The latter shows the well-definedness (needed to apply \cref{kraus-glueing})
  of a global map $T\simeq T'$, given by sending $t_i(x)$ to $t'_i(x)$
  for all $i$ and $x$.

  The map $\iota$ is also a surjection and therefore an isomorphism:
  Let $s:\ker(\partial^1)$.
  Then we can contruct a torsor,
  by starting with the trivial torsor on each $U_i$.
  We use \cref{kraus-glueing-1-type} to get a torsor
  with the identification given by the $s_{ij}$
  where the cocycle condition holds because $s$ is in the kernel.

  Realizing, that $\im(\partial^0)$ corresponds to the subtype of $T(\mathcal F,U)$ of trivial torsors,
  we arrive at the following diagram:
  \begin{center}
    \begin{tikzcd}
      & \Tors{\mathcal F}(X)\ar[r,->>] & H^1(X,\mathcal F) \\
      \sum_{T:T(\mathcal F,U)}\|\pi_1(T)=\mathcal F\|\ar[r,hook] & T(\mathcal F,U)\ar[u,->>]\ar[d,equal] & \\
      \im{\partial^0}\ar[r,hook]\ar[u,equal] & \ker{\partial^1}\ar[r,->>] & \check{H}^1(\{U\},\mathcal F)
    \end{tikzcd}
  \end{center}
  By \cref{MISSING},
  the composed map $T(\mathcal F,U)\to H^1(X,\mathcal F)$ is a homomorphism
  and therefore by \cref{surjective-abgroup-hom-is-cokernel} a cokernel.
  So the two cohomology groups are equal, since they are cokernels of the same diagram.
\end{proof}
