In \cref{schemes} we defined a scheme to be a type $X$ such that $X$
may be covered by finitely many open affine subtypes.
In this section, we will present general properies of schemes and a couple of common constructions for schemes.


\subsection{General Properties}

\begin{lemma}[using \axiomref{sqc}, \axiomref{loc}]%
  \label{intersection-of-all-opens}
  Let $X$ be a scheme and $x:X$, then for all $y:X$ the proposition
  \[ \prod_{U:X\to \Open}U(x)\to U(y) \]
  is equivalent to $\neg\neg (x=y)$.
\end{lemma}

\begin{proof}
  By \cref{open-union-intersection},
  open proposition are always double-negation stable,
  which settles one implication.
  For the implication
  \[ \left(\prod_{U:X\to \Open}U(x)\to U(y)\right) \Rightarrow \neg\neg (x=y) \]
  we can assume that $x$ and $y$ are both inside an open affine $U$
  and use that the statement holds for affine schemes by \cref{affine-intersection-of-all-opens}.
\end{proof}

\subsection{Glueing}

\begin{proposition}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  Let $X,Y$ be schemes and $f:U\to X$, $g:U\to Y$ be embeddings with open images in $X$ and $Y$,
  then the pushout of $f$ and $g$ is a scheme.
\end{proposition}

\begin{proof}
  As we noted in \cref{MISSING}, such a pushout is always 0-truncated.
  Let $U_1,\dots,U_n$ be a cover of $X$ and $V_1,\dots,V_m$ be a cover of $Y$.
  By \cref{qc-open-trans}, $U_i\cap U$ is open in $Y$,
  so we can use (large) pushout-recursion to construct a subtype $\tilde{U_i}$,
  which is open in the pushout and restricts to $U_i$ on $X$ and $U_i\cap U$ on $Y$.
  Symetrically we define $\tilde{V_i}$ and in total get an open finite cover of the pushout.
  The pieces of this new cover are equivalent to their counterparts in the covers of $X$ and $Y$,
  so they are affine as well.
\end{proof}

\subsection{Subschemes}

\begin{definition}
  Let $X$ be a scheme.
  A \notion{subscheme} of $X$ is a subtype $Y:X\to\Prop$,
  such that $\sum Y$ is a scheme.
\end{definition}

\begin{proposition}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  \label{open-subscheme}
  Any open subtype of a scheme is a scheme.
\end{proposition}

\begin{proof}
  Using \cref{qc-open-affine-open}.
\end{proof}

\begin{proposition}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  \label{closed-subscheme}
  Any closed subtype $A:X\to \Prop$ of a scheme $X$ is a scheme.
\end{proposition}

\begin{proof}
  Any open subtype of $X$ is also open in $A$.
  So it is enough to show,
  that any affine open $U_i$ of $X$,
  has affine intersection with $A$.
  But $U_i\cap A$ is closed in $U_i$ and therefore affine by \cref{closed-subtype-affine}.
\end{proof}

We can extend the operation from \cref{affine-n-th-inf-neighborhood}
to schemes:

\begin{definition}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  Let $X$ be a scheme and $C\subseteq X$ a closed subscheme.
  Then $C^n$ is the closed subscheme of $X$,
  defined locally as in \cref{affine-n-th-inf-neighborhood}.
\end{definition}

\begin{proof}
  We need the axioms to locally get ideals that generate the closed subscheme.
  We need to show that the construction can be done locally,
  but this is the case, since for any open affine $U$,
  $(C\cap U)^n\subseteq \neg\neg (C\cap U)\subseteq U$ by \cref{MISSING}.
\end{proof}

\begin{lemma}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  \label{dense-closed-n-th-neighborhood}
  Let $U\subseteq X$ be a dense open subtype of a scheme.
  For any closed subtype $V$ containing $U$,
  there merely is an $n:\N$, such that $V^n=X$.
\end{lemma}

\begin{proof}
  It is enough to do the construction for an open affine $W=\Spec A$,
  where $V\cap U=\Spec A/(f_1,\dots,f_n)$ and
  $U=D(g_1,\dots,g_l)$.
  By \cref{dense-is-jointly-nilregular} we can assume the $g_1,\dots,g_l$
  are jointly nilregular.
  For any $f_i$ we know $f_i\cdot g_j$ is nilpotent, since
  \[ \neg D(f_ig_j)=\neg\{x:W\mid f_ig_i(x)\text{ invertible}\} =\emptyset\rlap{,}\]
  since if $f_ig_j(x)$ is invertible, then $g_j(x)$ is invertible, but then, we are in
  $U$ and $f_i(x)$ has to be zero, which contradicts its invertibility.

  By the joint nilregularity of the $g_j$, $f_i$ is nilpotent,
  so $f_i^n=0$ and $V^n=W$.
\end{proof}

In the situation of a clopen subset, we get the classical equality:

\begin{lemma}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  \label{clopen-dense-is-all}
  Let $U\subseteq X$ be a dense open and closed subtype of a scheme,
  then $U=X$
\end{lemma}

\begin{proof}
  By \cref{dense-closed-n-th-neighborhood},
  $U^n=X$.
  By \cref{affine-n-th-inf-neighborhood-formal}, we have
  \[
    X\subseteq U^n\subseteq \neg\neg U = U\rlap{.}
  \]
\end{proof}

\begin{theorem}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  The ring $R$ is not coherent, i.e. it is not the case,
  that all finitely generated ideals in $R$ are finitely presented.
\end{theorem}

\begin{proof}
  We will show, that it is not the case,
  that any $R$-module map $R\to R$ has a finitely generated kernel.
  So let $\varphi:R\to R$ be $R$-linear and $x\colonequiv \varphi(1)$.
  Assume it is always possible to find generators $y_1,\dots,y_n:R$ of the kernel of $\varphi$.
  That means there is a map
  \[
    c:\prod_{x:R}
    \left(
      \exists_{y_1,\dots,y_n:R}
      \prod_{z:R}
      \left(
        \varphi(z)=0 \text{ iff } \exists_{\lambda_1,\dots,\lambda_n:R}z=\sum_{i=1}^n \lambda_i y_i
      \right)
    \right)
    \rlap{.}
  \]
  By \axiomref{Z-choice} and boundedness,
  we translate the first ``$\exists$'' to a function $g:R\to R^n$ on a neighborhood $D(f)$ of $0:R$.
  We know that if $\varphi(1)$ is invertible, then $\ker(\varphi)=(0)$, which means $y_i=0$ for all $i$.
  So $g(x)$ must be the 0-vector for all $x:D(f)\cap D(X)$.
  Now $D(X)$ and $D(f)$ are both non-empty and therefore dense,
  since $\A^1$ is irreducible by \cref{A1-irreducible}.
  By \cref{basic-dense-operations} $D(f)\cap D(X)$ is dense,
  so by \cref{dense-closed-n-th-neighborhood} the entries of $g(x)$ must be nilpotent for all $x:R$.
  But this is a contradiction, since for $\varphi(x)=0$,
  the kernel is $R$ and there must be an invertible entry in $g(x)$.
\end{proof}

\subsection{Equality types}

\begin{lemma}%
  \label{affine-equality-closed}
  Let $X$ be an affine scheme and $x,y:X$,
  then $x=_Xy$ is an affine scheme
  and $((x,y):X\times X)\mapsto x=_Xy$
  is a closed subtype of $X\times X$.
\end{lemma}

\begin{proof}
  Any affine scheme is merely embedded into $\A^n$ for some $n:\N$.
  The proposition $x=y$ for elements $x,y:\A^n$ is equivalent to $x-y=0$,
  which is equivalent to all entries of this vector being zero.
  The latter is a closed proposition.
\end{proof}

\begin{proposition}[using \axiomref{sqc}, \axiomref{loc}, \axiomref{Z-choice}]%
  \label{equality-scheme}
  Let $X$ be a scheme.
  The equality type $x=_Xy$ is a scheme for all $x,y:X$.
\end{proposition}

\begin{proof}
  Let $x,y:X$ and
  $U\subseteq X$ be an affine open containing $x$.
  Then $U(y)\wedge x=y$ is equivalent to $x=y$, so it is enough to show that $U(y)\wedge x=y$ is a scheme.
  As a open subscheme of the point, $U(y)$ is a scheme and $(x:U(y))\mapsto x=y$ defines a closed subtype by \cref{affine-equality-closed}.
  But this closed subtype is a scheme by \cref{closed-subscheme}.
\end{proof}

\subsection{Dependent sums}

\begin{theorem}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  \label{sigma-scheme}
  Let $X$ be a scheme and for any $x:X$, let $Y_x$ be a scheme.
  Then the dependent sum
  \[ \left((x:X)\times Y_x\right)\equiv \sum_{x:X}Y_x\]
  is a scheme.
\end{theorem}

\begin{proof}
  We start with an affine $X=\Spec A$ and $Y_x=\Spec B_x$.
  Locally on $U_i = D(f_i)$, for a Zariski-cover $f_1,\dots,f_l$ of $X$,
  we have $B_x=\Spec R[X_1,\dots,X_{n_i}]/(g_{i,x,1},\dots,g_{i,x,m_i})$
  with polynomials $g_{i,x,j}$.
  In other words, $B_x$ is the closed subtype of $\A^{n_i}$
  where the functions $g_{i,x,1},\dots,g_{i,x,m_i}$ vanish.
  By \cref{affine-fiber-product}, the product
  \[ V_i\colonequiv U_i\times \A^{n_i}\]
  is affine.
  The type $(x:U_i)\times \Spec B_x\subseteq V_i$ is affine,
  since it is the zero set of the functions
  \[ ((x,y):V_i)\mapsto g_{i,x,j}(y) \]
  Furthermore, $W_i\colonequiv (x:U_i)\times \Spec B_x$
  is open in $(x:X)\times Y_x$,
  since $W_i(x)$ is equivalent to $U_i(\pi_1(x))$,
  which is an open proposition.

  This settles the affine case.
  We will now assume, that
  $X$ and all $Y_x$ are general schemes.
  We pass again to a cover of $X$ by affine open $U_1,\dots,U_n$.
  We can choose the latter cover,
  such that for each $i$ and $x:U_i$, the $Y_{\pi_1(x)}$
  are covered by $l_i$ many open affine pieces $V_{i,x,1},\dots,V_{i,x,l_i}$
  (by \cref{boundedness}).
  Then $W_{i,j}\colonequiv(x:U_i)\times V_{i,x,j}$ is affine by what we established above.
  It is also open.
  To see this, let $(x,y):((x:X)\times Y_x)$.
  We want to show, that $(x,y)$ being in $W_{i,j}$ is an open proposition.
  We have to be a bit careful, since the open proposition
  $V_{i,x,j}$ is only defined, for $x:U_i$.
  So the proposition we are after is $(z:U_i(x,y))\times V_{i,z,j}(y)$.
  But this proposition is open by \cref{qc-open-sigma-closed}.
\end{proof}

\begin{corollary}
  \label{scheme-map-classification}
  Let $X$ be a scheme.
  For any other scheme $Y$ and any map $f:Y\to X$,
  the fiber map
  $(x:X)\mapsto \fib_f(x)$
  has values in the type of schemes $\Sch$.
  Mapping maps of schemes to their fiber maps,
  is an equivalence of types
  \[ \left(\sum_{Y:\Sch}(Y\to X)\right)\simeq (X\to \Sch)\rlap{.}\]
\end{corollary}

\begin{proof}
  By univalence, there is an equivalence
  \[ \left(\sum_{Y:\Type}(Y\to X)\right)\simeq (X\to \Type)\rlap{.} \]
  From left to right, the equivalence is given by turning a $f:Y\to X$ into $x\mapsto \fib_f(x)$,
  from right to left is given by taking the depedent sum.
  So we just have to note, that both constructions preserve schemes.
  From left to right, this is \cref{fiber-product-scheme}, from right to left,
  this is \cref{sigma-scheme}.
\end{proof}

Subschemes are classified by propositional schemes:

\begin{corollary}
  Let $X$ be a scheme.
  $Y:X\to\Prop$ is a subscheme,
  if and only if $Y_x$ is a scheme for all $x:X$.
\end{corollary}

\begin{proof}
  Restriction of \cref{scheme-map-classification}.
\end{proof}

\subsection{Pullbacks of Schemes}

In this section, we will show in two different ways,
that the pullback of a cospan of schemes is a scheme.
The first poof is very short and reuses what we proved about equality and sigma-types,
the second proof is more direct, uses the proof of the affine case \cref{affine-fiber-product}
and is along the lines of what one might find in an algebraic geometry textbook.

\begin{theorem}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  \label{fiber-product-scheme}
  Let
  \[
    \begin{tikzcd}
      X\ar[r,"f"] & Z & Y\ar[l,swap,"g"]
    \end{tikzcd}
  \]
  be schemes, then the \notion{pullback} $X\times_Z Y$ is also a scheme.
\end{theorem}

\begin{proof}
  The type $X\times_Z Y$ is given as the following, interated dependent sum:
  \[ \sum_{x:X}\sum_{y:Y}f(x)=g(y)\rlap{.}\]
  The innermost type, $f(x)=g(y)$
  is the equality type in the scheme $Z$ and by \cref{equality-scheme} a scheme.
  By applying \cref{sigma-scheme} twice, we prove that the itereated dependent sum is a scheme.
\end{proof}

We conclude with a construction, analogous to the classical treatment:

\begin{proof}[alternative proof of \cref{fiber-product-scheme}]
  Let $W_1,\dots,W_n$ be a finite affine cover of $Z$.
  The preimages of $W_i$ under $f$ and $g$ are open
  and covered by fintely many affine open $U_{ik}$ and $V_{ij}$ by \cref{open-subscheme}.
  This leads to the following diagram:
  \begin{center}
    \begin{tikzcd}
      X\times_Z Y\ar[rrr]\ar[ddd] & & & Y\ar[ddd] & \\
      & P_{ij}\ar[hook,lu]\ar[rrr,crossing over] &&& V_{ij}\ar[hook,lu]\ar[ddd] \\
      &&&& \\
      X\ar[rrr] & & & Z & \\
      & U_{i}\ar[rrr]\ar[hook,lu]\ar[from=uuu,crossing over] & & & W_i\ar[hook,lu]
    \end{tikzcd}
  \end{center}
  where the front and bottom square are pullbacks by definition.
  By pullback-pasting, the top is also a pullback,
  so all diagonal maps are embeddings.
  
  $P_{ij}$ is open, since it is a preimage of $V_{ij}$ (\cref{preimage-open}),
  which is open in $Y$ by \cref{qc-open-trans}.
  It remains to show, that the $P_{ij}$ cover $X\times_Z Y$ and that $P_{ij}$ is a scheme.
  Let $x:X\times_Z Y$.
  For the image $w$ of $x$ in $W$, there merely is an $i$ such that $w$ is in $W_i$.
  The image of $x$ in $V_i$ merely lies in some $V_{ij}$,
  so $x$ is in $P_{ij}$.

  We proceed by showing that $P_{ij}$ is a scheme.
  Let $U_{ik}$ be a part of the finite affine cover of $U_i$.
  We repeat part of what we just did:
  \begin{center}
    \begin{tikzcd}
      P_{ij}\ar[rrr]\ar[ddd] & & & U_i\ar[ddd] & \\
      & P_{ijk}\ar[hook,lu]\ar[rrr,crossing over] &&& U_{ik}\ar[hook,lu]\ar[ddd] \\
      &&&& \\
      V_{ij}\ar[rrr] & & & W_i & \\
      & V_{ij}\ar[rrr]\ar[equal,lu]\ar[from=uuu,crossing over] & & & W_i\ar[equal,lu]
    \end{tikzcd}
  \end{center}

  So by \cref{affine-fiber-product}, $P_{ijk}$ is affine.
  Repetition of the above shows, that the $P_{ijk}$ are open and cover $P_{ij}$.
\end{proof}

