\subsection{Affine-open subtypes}

We only talk about affine schemes of finite type, i.e. schemes of the form $\Spec A$ (\cref{spec}),
where $A$ is a finitely presented algebra.

\begin{definition}%
  A type $X$ is \notion{(qc-)affine},
  if there is a finitely presented $R$-algebra $A$, such that $X=\Spec A$.
\end{definition}

\begin{proposition}%
  Let $X$ be a type.
  The type of all finitely presented $R$-algebras $A$, such that $X=\Spec A$, is a proposition.
\end{proposition}

When we write ``$\Spec A$'' we implicitly assume $A$ is a finitely presented $R$-algebra.

\begin{definition}%
  \index{$D(f)$}
  Let $X=\Spec A$.
  A \notion{(affine) standard open} is the subtype $D(f):X\to\Prop$
  for some $f:\Spec A\to R$ given by $D(f)(x)\colonequiv \inv(f(x))$.
\end{definition}

\begin{example}[using \axiomref{loc}, \axiomref{sqc}]
  For $a_1, \dots, a_n : R$, we have
  \[ D((X - a_1) \dots (X - a_n)) = \A^1 \setminus \{ a_1, \dots, a_n \} \rlap{.}\]
  Indeed,
  for any $x : \A^1$,
  $((X - a_1) \dots (X - a_n))(x)$ is invertible if and only if
  $x - a_i$ is invertible for all $i$.
  But by \cref{non-zero-invertible}
  this means $x \neq a_i$ for all $i$.
\end{example}

\begin{definition}%
  \label{affine-open}
  Let $X=\Spec A$.
  A subtype $U:X\to\Prop$ is called \notion{affine-open},
  if one of the following logically equivalent statements holds:
  \begin{enumerate}[(i)]%
  \item $U$ is the union of finitely many affine standard opens.
  \item There are $f_1,\dots,f_n:A$ such that
    \[U(x) \Leftrightarrow \exists_{i} f_i(x)\neq 0 \]
  \end{enumerate}
\end{definition}

We sometimes write $D(f_1, \dots, f_n) \colonequiv D(f_1) \cup \dots \cup D(f_n)$
for a finite union of standard opens.
Note that in general, affine-open subtypes do not need to be affine
-- this is why we use the dash ``-''.

We will introduce a more general definition of open subtype in \cref{qc-open}
and show in \cref{qc-open-affine-open}, that the two notions agree on affine schemes.

\begin{proposition}
  Let $X = \Spec A$ and $f : A$.
  Then $D(f) = \Spec A[f^{-1}]$.
\end{proposition}

\begin{proof}
  \[ D(f) =
     \sum_{x : X} D(f)(x) =
     \sum_{x : \Spec A} \inv(f(x)) =
     \sum_{x : \Hom_{\Alg{R}}(A, R)} \inv(x(f)) =
     \Hom_{\Alg{R}}(A[f^{-1}], R) =
     \Spec A[f^{-1}]
     \]
\end{proof}

Affine-openness is transitive in the following sense:

\begin{lemma}%
  \label{affine-open-trans}
  Let $X=\Spec A$ and $D(f)\subseteq X$ be a standard open.
  Any affine-open subtype $U$ of $D(f)$ is also affine-open in $X$.
\end{lemma}

\begin{proof}
  It is enough to show the statement for $U=D(g)$, $g:A_f$.
  Then
  \[ g=\frac{h}{f^k}\rlap{.}\]
  Now $D(hf)$ is an affine-open in $X$,
  that coincides with $U$: \\
  Let $x:X$, then $(hf)(x)$ is invertible, if and only if both $h(x)$ and $f(x)$ are invertible.
  The latter means $x:D(f)$, so we can interpret $x$ as a homorphism from $A_f$ to $R$.
  Then $x:D(g)$ means $x(g)$ is invertible, which is equivalent to $x(h)$ being invertible,
  since $x(f)^k$ is invertible anyway.
\end{proof}

\begin{lemma}[using \axiomref{loc}, \axiomref{sqc}]%
  \label{standard-open-empty}
  Let $X=\Spec A$ be an affine scheme and $D(f)\subseteq X$ a standard open,
  then $D(f)=\emptyset$, if and only if, $f$ is nilpotent.
\end{lemma}

\begin{proof}
  Since $D(f)=\Spec A_f$, by \cref{weak-nullstellensatz}, we know $D(f)=\emptyset$,
  if and only if, $A_f=0$.
  The latter is equivalent to $f$ being nilpotent.
\end{proof}

More generally,
the Zariski-lattice consisting of the radicals
of finitely generated ideals of a finitely presented $R$-algebra $A$,
coincides with the lattice of open subtypes.
This means, that internal to the Zariski-topos,
it is not neccessary to consider the full Zariski-lattice for a constructive treatment of schemes.

\begin{lemma}[using \axiomref{sqc}]%
  Let $A$ be a finitely presented $R$-algebra
  and let $f, g_1, \dots, g_n \in A$.
  Then we have $D(f) \subseteq D(g_1, \dots, g_n)$
  as subsets of $\Spec A$
  if and only if $f \in \sqrt{(g_1, \dots, g_n)}$.
\end{lemma}

\begin{proof}
  Since $D(g_1, \dots, g_n) = \{\, x \in \Spec A \mid x \notin V(g_1, \dots, g_n) \,\}$,
  the inclusion $D(f) \subseteq D(g_1, \dots, g_n)$
  can also be written as
  $D(f) \cap V(g_1, \dots, g_n) = \varnothing$, that is,
  $\Spec((A/(g_1, \dots, g_n))[f^{-1}]) = \varnothing$.
  By (\axiomref{sqc})
  this means that the finitely presented $R$-algebra $(A/(g_1, \dots, g_n))[f^{-1}]$
  is zero.
  And this is the case if and only if $f$ is nilpotent in $A/(g_1, \dots, g_n)$,
  that is, if $f \in \sqrt{(g_1, \dots, g_n)}$, as stated.
\end{proof}

In particular,
we have $\Spec A = \bigcup_{i = 1}^n D(f_i)$
if and only if $(f_1, \dots, f_n) = (1)$.

\subsection{Pullbacks of affine schemes}

\begin{lemma}%
  \label{affine-product}
  The product of two affine schemes is again an affine scheme,
  namely
  $\Spec A \times \Spec B = \Spec (A \otimes_R B)$.
\end{lemma}

\begin{proof}
  By the universal property of the tensor product $A \otimes_R B$.
\end{proof}

More generally we have:

\begin{lemma}[using \axiomref{sqc}]%
  \label{affine-fiber-product}
  Let $X=\Spec A,Y=\Spec B$ and $Z=\Spec C$ be affine schemes
  with maps $f:X\to Z$, $g:Y\to Z$.
  Then the pullback of this diagram is an affine scheme given by $\Spec (A\otimes_C B)$.
\end{lemma}

\begin{proof}
  The maps $f:X\to Z$, $g:Y\to Z$ are induced by $R$-algebra homomorphisms $f^*:A\to R$ and $g^*:B\to R$.
  Let
  \[ (h,k,p) : \Spec A \times_{\Spec C} \Spec B \]
  with $p:h\circ f^*=k\circ g^* $.
  This defines a $R$-cocone on the diagram
  \[
    \begin{tikzcd}
      A & C\ar[r,"g^*"]\ar[l,"f^*",swap] & B
    \end{tikzcd}
  \]
  Since $A\otimes_C B$ is a pushout in $R$-algebras,
  there is a unique $R$-algebra homomorphism $A\otimes_C B \to R$ corresponding to $(h,k,p)$.
\end{proof}

\subsection{Boundedness of functions to $\N$}

While the axiom \axiomref{sqc}
describes functions on an affine scheme
with values in $R$,
we can generalize it to functions taking values
in another finitely presented $R$-algebra,
as follows.

\begin{lemma}[using \axiomref{sqc}]%
  \label{algebra-valued-functions-on-affine}
  For finitely presented $R$-algebras $A$ and $B$,
  the function
  \begin{align*}
    A \otimes B &\xrightarrow{\sim} (\Spec A \to B) \\
    c &\mapsto (\varphi \mapsto (\varphi \otimes B)(c))
  \end{align*}
  is a bijection.
\end{lemma}

\begin{proof}
  We recall $\Spec (A \otimes B) = \Spec A \times \Spec B$
  from \cref{affine-product}
  and calculate as follows.
  \begin{align*}
    A \otimes B
    &=& (\Spec (A \otimes B) \to R)
    &=& (\Spec A \times \Spec B \to R)
    &=& (\Spec A \to (\Spec B \to R))
    &=& (\Spec A \to B) \\
    c
    &\mapsto& (\chi \mapsto \chi(c))
    &\mapsto& ((\varphi, \psi) \mapsto (\varphi \otimes \psi)(c))
    &\mapsto& (\varphi \mapsto (\psi \mapsto (\varphi \otimes \psi)(c)))
    &\mapsto& (\varphi \mapsto (\varphi \otimes B)(c))
  \end{align*}
  The last step is induced by the identification
  $B = (\Spec B \to R),\, b \mapsto (\psi \mapsto \psi(b))$,
  and we use the fact that
  $\psi \circ (\varphi \otimes B) = \varphi \otimes \psi$.
\end{proof}

\begin{lemma}[using \axiomref{sqc}]%
  \label{eventually-vanishing-sequence-on-affine}
  Let $A$ be a finitely presented $R$-algebra
  and let $s : \Spec A \to (\N \to R)$
  be a family of sequences,
  each of which eventually vanishes:
  \[ \prod_{x : \Spec A} \propTrunc{\sum_{N : \N} \prod_{n \geq N} s(x)(n) = 0} \]
  Then there merely exists one number $N : \N$
  such that $s(x)(n) = 0$ for all $x : \Spec A$ and all $n \geq N$.
\end{lemma}

\begin{proof}
  The set of eventually vanishing sequences $\N \to R$
  is in bijection with the set $R[X]$ of polynomials,
  by taking the entries of a sequence as the coefficients of a polynomial.
  So the family of sequences $s$
  is equivalently a family of polynomials $s : \Spec A \to R[X]$.
  Now we apply \cref{algebra-valued-functions-on-affine} with $B = R[X]$
  to see that such a family corresponds to a polynomial $p : A[X]$.
  Note that for a point $x : \Spec A$,
  the homomorphism
  \[ x \otimes R[X] : A[X] = A \otimes R[X] \to R \otimes R[X] = R[X] \]
  simply applies the homomorphism $x$ to every coefficient of a polynomial,
  so we have $(s(x))_n = x(p_n)$.
  This concludes our argument,
  because the coefficients of $p$,
  just like any polynomial,
  form an eventually vanishing sequence.
\end{proof}

\begin{theorem}[using (\axiomref{loc}), (\axiomref{sqc})]%
  \label{boundedness}
  Let $A$ be a finitely presented $R$-algebra.
  Then every function $f : \Spec A \to \N$ is bounded:
  \[ \Pi_{f : \Spec A \to \N} \propTrunc{\Sigma_{N : \N} \Pi_{x : \Spec A} f(x) \le N}
     \rlap{.} \]
\end{theorem}

\begin{proof}
  Given a function $f : \Spec A \to \N$,
  we construct the family $s : \Spec A \to (\N \to R)$
  of eventually vanishing sequences
  given by
  \[
    s(x)(n) \colonequiv
    \begin{cases}
      \,1 &\text{if $n < f(x)$}\\
      \,0 &\text{else} \rlap{.}
    \end{cases}
  \]
  Since $0 \neq 1 : R$ by \axiomref{loc},
  we in fact have $s(x)(n) = 0$ if and only if $n \geq f(x)$.
  Then the claim follows from \cref{eventually-vanishing-sequence-on-affine}.
\end{proof}

If we also assume the axiom \axiomref{Z-choice},
we can formulate the following simultaneous strengthening
of \cref{eventually-vanishing-sequence-on-affine}
and \cref{boundedness}.

\begin{proposition}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  \label{strengthened-boundedness}
  Let $A$ be a finitely presented $R$-algebra.
  Let $P : \Spec A \to (\N \to \Prop)$
  be a family of upwards closed, merely inhabited subsets of $\N$.
  Then the set
  \[ \bigcap_{x : \Spec A} P(x) \subseteq \N \]
  is merely inhabited.
\end{proposition}

\begin{proof}
  By \axiomref{Z-choice},
  there merely exists a cover
  $\Spec A = \bigcup_{i = 1}^n D(f_i)$
  and functions $p_i : D(f_i) \to \N$
  such that $p_i(x) \in P(x)$ for all $x : D(f_i)$.
  By \cref{boundedness},
  every $p_i : D(f_i) = \Spec A[f_i^{-1}] \to \N$
  is merely bounded by some $N_i : \N$,
  and then $\mathrm{max}(N_1, \dots, N_n) \in P(x)$ for all $x : \Spec A$.
\end{proof}

\subsection{Properties of the ring $R$}

We adopt the following definition from
\cite[Section IV.8]{lombardi-quitte}.

\begin{definition}%
  \label{zero-dimensional-ring}
  A ring $A$ is \notion{zero-dimensional}
  if for all $x : A$
  there exists $a : A$ and $k : \N$
  such that $x^k = a x^{k + 1}$.
\end{definition}

\begin{lemma}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  \label{R-not-zero-dimensional}
  The ring $R$ is not zero-dimensional.
\end{lemma}

\begin{proof}
  Assume that $R$ is zero-dimensional,
  so for every $f : R$ there merely is some $k : \N$ with $f^k \in (f^{k + 1})$.
  We note that $R = \A^1$ is an affine scheme and
  that if $f^k \in (f^{k + 1})$,
  then we also have $f^{k'} \in (f^{k' + 1})$ for every $k' \geq k$.
  This means that we can apply \cref{strengthened-boundedness}
  and merely obtain a number $K : \N$
  such that $f^K \in (f^{K + 1})$ for all $f : R$.
  In particular, $f^{K + 1} = 0$ implies $f^K = 0$,
  so the canonical map
  $\Spec R[X]/(X^K) \to \Spec R[X]/(X^{K + 1})$
  is a bijection.
  But this is a contradiction,
  since the homomorphism $R[X]/(X^{K + 1}) \to R[X]/(X^K)$
  is not an isomorphism.
\end{proof}

The following lemma,
which is a variant of \cite{ingo-thesis}[Proposition 18.32],
shows that $R$ is in a weak sense algebraically closed.

\begin{lemma}[using \axiomref{loc}, \axiomref{sqc}]%
  \label{polynomials-notnot-decompose}
  Let $f : R[X]$ be a polynomial.
  Then it is not not the case that:
  either $f = 0$ or
  $f = \alpha \cdot {(X - a_1)}^{e_1} \dots {(X - a_n)}^{e_n}$
  for some $\alpha : R^\times$,
  $e_i \geq 1$ and pairwise distinct $a_i : R$.
\end{lemma}

\begin{proof}
  Let $f : R[X]$ be given.
  Since our goal is a proposition,
  we can assume we have a bound $n$ on the degree of $f$,
  so
  \[ f = \sum_{i = 0}^n c_i X^i \rlap{.} \]
  Since our goal is even double-negation stable,
  we can assume $c_n = 0 \lor c_n \neq 0$
  and by induction $f = 0$ (in which case we are done)
  or $c_n \neq 0$.
  If $n = 0$ we are done,
  setting $\alpha \colonequiv c_0$.
  Otherwise,
  $f$ is not invertible (using $0 \neq 1$ by (\axiomref{loc})),
  so $R[X]/(f) \neq 0$,
  which by (\axiomref{sqc}) means that
  $\Spec(R[X]/(f)) = \{ x : R \mid f(x) = 0 \}$
  is not empty.
  Using the double-negation stability of our goal again,
  we can assume $f(a) = 0$ for some $a : R$
  and factor $f = (X - a_1) f_{n - 1}$.
  By induction, we get $f = \alpha \cdot (X - a_1) \dots (X - a_n)$.
  Finally, we decide each of the finitely many propositions $a_i = a_j$,
  which we can assume is possible
  because our goal is still double-negation stable,
  to get the desired form
  $f = \alpha \cdot {(X - \widetilde{a}_1)}^{e_1} \dots {(X - \widetilde{a}_n)}^{e_n}$
  with distinct $\widetilde{a}_i$.
\end{proof}

\begin{example}[using \axiomref{loc}, \axiomref{sqc}, \axiomref{Z-choice}]%
  \label{non-existence-of-roots}
  It is not the case that
  every monic polynomial $f : R[X]$ with $\deg f \geq 1$ has a root.
  More specifically,
  if $U \subseteq \A^1$ is an open subset
  with the property that
  the polynomial $X^2 - a : R[X]$ merely has a root
  for every $a : U$,
  then $U = \emptyset$.
\end{example}

\begin{proof}
  Let $U \subseteq \A^1$ be as in the statement.
  Since we want to show $U = \emptyset$,
  we can assume a given element $a_0 : U$
  and now have to derive a contradiction.
  By \axiomref{Z-choice},
  there exists in particular a standard open $D(f) \subseteq \A^1$
  with $a_0 \in D(f)$
  and a function $g : D(f) \to R$
  such that ${(g(x))}^2 = x$ for all $x : D(f)$.
  By \axiomref{sqc},
  this corresponds to an element $\frac{p}{f^n} : R[X]_f$
  with ${(\frac{p}{f^n})}^2 = X : R[X]_f$.
  We use \cref{polynomial-with-regular-value-is-regular}
  together with the fact that $f(a_0)$ is invertible
  to get that $f : R[X]$ is regular,
  and therefore $p^2 = f^{2n}X : R[X]$.
  Considering this equation over $R^{\mathrm{red}} = R/\sqrt{(0)}$ instead,
  we can show by induction that all coefficients of $p$ and of $f^n$ are nilpotent,
  which contradicts the invertibility of $f(a_0)$.
\end{proof}

\begin{remark}
  \Cref{non-existence-of-roots} shows that
  the axioms we are using here
  are incompatible with a natural axiom that is true
  for the structure sheaf of the big étale topos,
  namely that $R$ admits roots for unramifiable monic polynomials.
  The polynomial $X^2 - a$ is even separable for invertible $a$,
  assuming that $2$ is invertible in $R$.
  To get rid of this last assumption,
  we can use the fact that either $2$ or $3$ is invertible in the local ring $R$
  and observe that the proof of \cref{non-existence-of-roots}
  works just the same for $X^3 - a$.
\end{remark}
