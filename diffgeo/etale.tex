
\subsection{Lifting Properties}

\begin{example}
  Let us assume $2\neq 0$ in $R$ and look at the following square:
  \begin{center}
    \begin{tikzcd}
      1\ar[r]\ar[d] & \A^1\setminus\{0\}\ar[d,"x\mapsto x^2"] \\
      \D(1)\ar[r] & \A^1\setminus\{0\}
    \end{tikzcd}
  \end{center}
  As the bottom map, we choose the inclusion of $\{x:R^\times \mid (x-1)^2=0 \}$.
  Then, for any choice of the top map, there is a unique lift in this square:
  \begin{center}
    \begin{tikzcd}
      1\ar[r]\ar[d] & \A^1\setminus\{0\}\ar[d,"x\mapsto x^2"] \\
      \D(1)\ar[r]\ar[ru,dashed] & \A^1\setminus\{0\}
    \end{tikzcd}
  \end{center}
\end{example}

A non-fintely generated version of the following definition is usually used
to define \emph{formally étale} maps of schemes
\footnote{In \cite{EGAIV3}[§17], the definition of formally étale maps ranges over arbitrary ideals, but uses the same lifting condition as below.}
and then it is subsequently noted,
that formally étale maps of finite presentation are étale.
Since all of our schemes are of finite presentations, this should be a correct definition of étale morphism:

\begin{definition}
  \begin{enumerate}[(a)]
  \item   A map $f:X\to Y$ is \notion{formally étale},
    if for all finitely presented $R$-algebras $A$ and all finitely generated nilpotent ideals $N\subseteq A$,
    and all squares like below, there is a unique lift:
    \begin{center}
      \begin{tikzcd}
        \Spec (A/N)\ar[r]\ar[d,"\iota",swap] & X\ar[d,"f"] \\
        \Spec A \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
    -- where $\iota:\Spec (A/N)\to \Spec A$ is induced by the quotient map.
  \item A map $f:X\to Y$ of schemes is \notion{étale}, if it is formally étale.
  \end{enumerate}
\end{definition}

Another way to phrase our definition of formally étale maps would be to say,
that they are the maps with the right lifting property (\cite{modalities}[definition 1.45]) with respect to ``left`` maps of the form $\Spec (A/N)\to \Spec A$.
We will use some well known, general closure properties of left maps, starting with closure under composition:

\begin{lemma}%
  If a map $f$ has the left lifting property with respect to $l:A_0\to A_1$ and $l':A_1\to A_2$,
  then $f$ has the left lifting property with respect to $l'\circ l$.
\end{lemma}

\begin{proof}
  TODO
\end{proof}

\begin{lemma}%
  A map $f:X\to Y$ is formally étale,
  if and only if it has unique lifts against left maps of the form $\Spec A/(a)\to \Spec A$,
  where $a:A$ with $a^2=0$.
\end{lemma}

\begin{lemma}%
  \label{nilpotent-ideal-not-not-dense}
  Let $A$ be a finitely presented $R$-algebra and $N\subseteq A$ be finitely generated nilpotent.
  Then for $V\colonequiv \Spec (A/N)\subseteq \Spec A$ the following holds:
  \begin{enumerate}[(a)]
  \item For all $x:\Spec A$, $\neg\neg V(x)$.
  \item If $V=\emptyset$, then $\Spec A=\emptyset$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  \begin{enumerate}[(a)]
  \item
    Let $x : \Spec A$ be given.
    The generators $n_1,\dots,n_l$ of $N$ are nilpotent functions,
    so in particular the elements $n_1(x), \dots, n_l(x)$ of $R$
    are not not zero.
    This means precisely $\neg\neg V(x)$.
  \item Assume $V=\emptyset$ and $x:\Spec A$.
        We want to show the $\neg\neg$-stable proposition $\emptyset$,
        so we can assume $V(x)$, which is a contradiction.
  \end{enumerate}
\end{proof}

\begin{proposition}%
  Let $P$ be a $\neg\neg$-stable proposition,
  then $P\to 1$ is formally étale.
\end{proposition}

\begin{proof}
  Direct application of \cref{nilpotent-ideal-not-not-dense}.
\end{proof}

\begin{proposition}%
  The map $\Bool\to 1$ is étale.
\end{proposition}

\begin{proof}
  We have to extend maps $f:\Spec (A/(a))\to \Bool$, with $a^2=0$.
  Since $\Bool\subseteq R$, the map $f$ yields an element $f:A/(a)$
  and we have a lift $\tilde{f}:A$ with $f=\tilde{f}+ab$.
  By \cref{nilpotent-ideal-not-not-dense},
  we have for any $x:\Spec A$, that $\neg\neg(\tilde{f}(x)=0)$ or $\neg\neg(\tilde{f}(x)=1)$.

  By Z-choice or computation, we find a $n:\N$,
  such that $\tilde{f}^n(x)=0$ or $\neg\neg(\tilde{f}^n(x)=1)$.
  With the map $1-\_:R\to R$, we can achieve the same for $1$.
\end{proof}

\begin{proposition}%
	\label{decidable-of-tangent}
	Let $X$ be an affine scheme and $a : X$ a point. Suppose the tangent space
	$T_a X$ has a unique point. Then for any $b : X$, equality $a = b$ is decidable.
\end{proposition}

\begin{proof}
	Let $X = \Spec R[X_1,\ldots,X_n]/(f_1,\ldots,f_l)$.
	For $j = 1,\ldots,l$, we have $f_j(a) = 0$, so by the division algorithm
	we can write $f_j = \sum_{i = 1}^n (X_i-a_i)q_{ij}$, where
	$q_{ij} \in R[X_1,\ldots,X_n]$.
	It can be seen that $q_{ij}(a) = \partial_{X_i}f_j$.
	The tangent space $T_a X$ is thus the kernel of $q(a)$ viewed as 
	linear map $R^n \to R^l$.
	Since this is zero, we have that $q(a)$ viewed as a linear map
	$R^l \to R^n$ is surjective.
	We claim that if $q(b)$ is also surjective viewed as a linear map
	$R^l \to R^n$, then $a = b$.
	Let us show $a_i = b_i$ for a given $i$.
	By assumption, we can find a vector $p : R^l$ such
	that $\sum_j q_{kj}(b)p_j = \delta_{ki}$.
	Now we compute
	\[
	0 = \sum_j f_j(b)p_j 
	= \sum_j \sum_k (b_k-a_k)q_{kj}(b)p_j 
	= \sum_k (b_k-a_k) \sum_j q_{kj}(b)p_j 
	= \sum_k (b_k-a_k) \delta_{ki} 
	= b_i - a_i.
	\]
	Thus if $q(b)$ is surjective then $a = b$. The converse is also true,
	since $q(a)$ is surjective.
	Moreover, the proposition asserting that $q(b)$ is surjective
	is open, being equivalent to the assertion that some 
	$n \times n$-submatrix of $q(b)$ has invertible determinant.
	Thus $a = b$ itself is an open proposition. 
	Since it is also closed, it must be decidable.
\end{proof}

\begin{proposition}%
	Let $X$ be a separated \'{e}tale scheme. Then $X$ has decidable equality.
\end{proposition}

\begin{proof}
	Let $a, b : X$. Since $X$ is separated, $a = b$ is closed.
	We claim it is also open.
	To see this, pick an affine open neighbourhood $U$ of $a$.
	Now $a = b$ is equivalent to $(b \in U) \wedge (a = b)$.
	Since open propositions are closed under $\Sigma$,
	it suffices to show that $a = b$ is open assuming $b \in U$.
	In this case we can apply \cref{decidable-of-tangent}.
\end{proof}

\subsection{Unramified morphisms}

This Section is due to Hugo Moeneclaey.

\begin{definition}
For any types $X,Y$, a map $f:X\to Y$ is called formally unramified if for any closed proposition $P$ such that $\neg\neg P$ the following square has at most one lift:
 \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
\end{definition}

\begin{definition}
A map $f:X\to Y$ is unramified if $X$ and $Y$ are schemes and $f$ is formally unramified.
\end{definition}

It is clear that formally étale maps are formally unramified. As usual a type $X$ is called formally unramified if the map from $X$ to $1$ is unramified, and a map is formally unramified if and only if all its fibers are formally unramified.

\begin{lemma}
A type $X$ is formally unramified if and only if for any $x,y:X$ and any dense closed proposition $P$ we have:
\[
(P\to x=y)\to x=y
\]
\end{lemma}

\begin{proposition}
A scheme $X$ is unramified if and only if any of the following propositions hold:
  \begin{enumerate}[(i)]
  \item For all $x,y:X$, the proposition $x=y$ is open.
  \item For all $x,y:X$, the proposition $x=y$ is $\neg\neg$-stable.
  \item For all $x:X$, we have $T_x(X)=0$.
  \item For all infinitesimal pointed type $(D,*)$ (meaning that for all $x:D$ we have $\neg\neg(x=*)$), any map from $D$ to $X$ is constant.
  \end{enumerate}
\end{proposition}

\begin{proof}
First we prove that the four propositions are equivalent:

(i) implies (ii) because open propositions are $\neg\neg$-stable.

(ii) implies (iv) because for any $f:D\to X$ and $x:D$ we have $\neg\neg(x=*)$ so that $\neg\neg(f(x)=f(*))$ and finally $f(x)=f(*)$.

(iv) implies (iii) by taking $D=\mathbb{D}(1)$.

(iii) implies (i) because for any $x:X$ there an open affine $U$ such that $x\in U$. Then $x=y$ is equivalent to $(y\in U)\land x=_U y$, but $x=_Uy$ is decidable by \cref{decidable-of-tangent} and open propositions are stable by $\Sigma$.

Now we check they are equivalent to being unramified:

(ii) implies unramified, indeed we need to check that for $x,y:X$ and $P$ closed dense such that $P\to x=y$, we have $x=y$. But $\neg\neg P$ so that $\neg\neg(x=y)$, and by (ii) we have $x=y$.

Unramified implies (iii) because it implies having at most one lifting against any closed dense subtype, so that by considering $1\subset \mathbb{D}(1)$ it implies having at most one tangent vector.
\end{proof}

\begin{lemma}
\label{kernel-is-tangent-of-fibers}
For any map $f:X\to Y$ and $x:X$, we have that:
\[
\mathrm{Ker}(df_x) = T_{(x,\refl_{f(x)})}(\mathrm{fib}_f(f(x)))
\]
\end{lemma}
\begin{proof}
This holds because:
\[
(\mathrm{fib}_f(f(x)),(x,\refl_{f(x)}))
\]
is the pullback of:
\[
(X,x) \to (Y,f(y)) \leftarrow (1,*)
\]
in pointed types, applied using $(\mathbb{D}(1),0)$.
\end{proof}

\begin{proposition}
A map between schemes is unramified if and only if its differentials are injective. 
\end{proposition}
\begin{proof}
The map $df_x$ is injective if and only if its kernel is $0$. By \cref{kernel-is-tangent-of-fibers}, this means that $df_x$ is injective for all $x:X$ if and only if:
\[
\prod_{x:X}T_{(x,\refl_{f(x)})}(\mathrm{fib}_f(f(x)))=0
\]
On the other hand having fibers with trivial tangent space is equivalent to:
\[
\prod_{y:Y}\prod_{x:X}\prod_{p:f(x)=y} T_{(x,p)}(\mathrm{fib}_f(y)) = 0
\]
Both are equivalent by path elimination on $p$.
\end{proof}


