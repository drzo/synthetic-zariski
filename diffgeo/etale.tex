\subsection{Generalities on modalities}

In this section we state useful facts about modalities in HoTT. We assume $L$ a left exact modality and $L'$ the modality corresponding to $L$-separated types, i.e. types with $L$-modal identity types. We have in mind $L$ the formally étale modality and $L'$ the formally unramified modality. Precise references should be added.

\begin{lemma}
If $L$ is accessible (i.e. defined by unique litfting conditions), then $L'$ is defined by the corresponding 'at most one' lifting conditions.
\end{lemma}

\begin{lemma}
The modality $L$ preserves $n$-types for any $n$.
\end{lemma}

The following is one of the many equivalent characterisations of left exact modalities.

\begin{lemma}
For any $X$ the localisation $\eta_X:X\to L(X)$ induces $L$-localisations:
\[x=_Xy \to \eta_X(x)=_{LX}\eta_X(y)\]
\end{lemma}

\begin{proposition}
\label{separatedLocalisationIsQuotient}
A map $f:X\to Y$ is an $L'$-localisation if and only if $f$ is surjective and for all $x,y:X$ the map:
\[ap_f : x=_Xy\to f(x)=_Yf(y)\] 
is an $L$-localisation.
\end{proposition}

\begin{corollary}
The modality $L'$ preserve $n$-types for any $n$.
\end{corollary}

\begin{corollary}
If $X$ is $L'$-modal then:
\[X\to LX\]
is an embedding.
\end{corollary}

This means that the successive localisations:
\[X\to L'X\to LX\]
are the image factorisation of the localisation $X\to LX$.

\subsection{Lifting Properties}

\begin{lemma}%
  If a map $f$ has the left lifting property with respect to $l:A_0\to A_1$ and $l':A_1\to A_2$,
  then $f$ has the left lifting property with respect to $l'\circ l$.
\end{lemma}

\begin{lemma}
\label{lifts-equivalence-pointwise}
Assume given a commutative square of the form:
 \begin{center}
    \begin{tikzcd}
      A \ar[r,"g"]\ar[d,swap,"u"]& X\ar[d,"p"]\\
      B \ar[r,swap,"f"]& Y
    \end{tikzcd}
  \end{center}
Then the following are equivalent:
\begin{enumerate}[(i)]
\item A lift of the square.
\item For all $b:B$ a lift of:
 \begin{center}
    \begin{tikzcd}
      \mathrm{fib}_u(b)\ar[d]\ar[r,"g"] & X\ar[d,"p"]\\
      1 \ar[r,swap,"f(b)"]& Y
    \end{tikzcd}
  \end{center}
 \item For all $b:B$ a lift of:
  \begin{center}
    \begin{tikzcd}
      \mathrm{fib}_u(b)\ar[r,"g"]\ar[d] & \mathrm{fib}_p(f(b))\ar[d]\\
      1 \ar[r] & 1
    \end{tikzcd}
  \end{center}
\end{enumerate}
\end{lemma}

\begin{proof}
We have that (ii) is equivalent to (iii) by definition of the fiber.

We can assume that the square is of the form:
 \begin{center}
    \begin{tikzcd}
   \sum_{b:B}P_b\ar[d]\ar[r] & \sum_{y:Y} Q_y\ar[d]\\
     B \ar[r,swap,"f"]& Y
    \end{tikzcd}
  \end{center}
  where the top map is:
  \[
  \lambda (b,p). (f(b),g(b,p))
  \]
  for some $g:\prod_{b:B} P_b \to Q_{f(b)}$. A lift of this square is the same as an inhabitant of:
 % \[
 % h : B \to \sum_{y:Y}Q_y
 % \]
  %such that $\pi_Y\circ h = f$ and for all $b:B$ and $p:P(b)$ we have $(f(b),g(b,p)) = h(b)$. But this is equivalent to a giving:
  %\[
  %h: \prod_{b:B}Q_{f(b)}
  %\]
  % such that for all $b:B$ and $p:P(b)$ we have $g(b,p) = h(b)$. This in turn is the same as an inhabitant of:
  \[
  \prod_{b:B} \sum_{q:Q_{f(b)}} \prod_{p:P_b} g(b,p)=q
  \]
  which is equivalent to (iii).
\end{proof}

\begin{lemma}
\label{pointwise-lift-is-enough}
Assume given maps $u:A\to B$ and $p:X\to Y$.
Then if $p$ has the right lifting property (resp. at most one lift) against $\mathrm{fib}_u(b)\to 1$ for all $b:B$, then it has the right lifting property (resp. at most one lift) against $u$.
\end{lemma}

\begin{proof}
By \cref{lifts-equivalence-pointwise} a lift of a square
 \begin{center}
    \begin{tikzcd}
      A \ar[r]\ar[d,swap,"u"]& X\ar[d,"p"]\\
      B \ar[r]& Y
    \end{tikzcd}
  \end{center}
  is equivalent a family of lifts of squares of the form: 
   \begin{center}
    \begin{tikzcd}
      \mathrm{fib}_u(b)\ar[d]\ar[r] & X\ar[d,"p"]\\
      1 \ar[r]& Y
    \end{tikzcd}
  \end{center}
  But a product of contractible types (resp. propositions) is itself contractible (resp. a proposition) so we can conclude. 
\end{proof}

\begin{lemma}
\label{lifting-defined-fiberwise}
A map $p$ has the right lifting property (resp. at most one lift) against a map $P\to 1$ if and only all the fibers of $p$ have this property against $P\to 1$.
\end{lemma}

\begin{proof}
This is an immediate consequence of the universal property of the fibers.
\end{proof}

\subsection{Formally étale maps}

\begin{example}
  Let us assume $2\neq 0$ in $R$ and look at the following square:
  \begin{center}
    \begin{tikzcd}
      1\ar[r]\ar[d] & \A^1\setminus\{0\}\ar[d,"x\mapsto x^2"] \\
      \D(1)\ar[r] & \A^1\setminus\{0\}
    \end{tikzcd}
  \end{center}
  As the bottom map, we choose the inclusion of $\{x:R^\times \mid (x-1)^2=0 \}$.
  Then, for any choice of the top map, there is a unique lift in this square:
  \begin{center}
    \begin{tikzcd}
      1\ar[r]\ar[d] & \A^1\setminus\{0\}\ar[d,"x\mapsto x^2"] \\
      \D(1)\ar[r]\ar[ru,dashed] & \A^1\setminus\{0\}
    \end{tikzcd}
  \end{center}
\end{example}

A non-finitely generated version of the following definition is usually used
to define \emph{formally étale} maps of schemes
\footnote{In \cite{EGAIV3}[§17], the definition of formally étale maps ranges over arbitrary ideals, but uses the same lifting condition as below.}
and then it is subsequently noted,
that formally étale maps of finite presentation are étale.
Since all of our schemes are of finite presentations, this should be a correct definition of étale morphism:

\begin{definition}
  \begin{enumerate}[(a)]
  \item   A map $f:X\to Y$ is \notion{formally étale},
    if for all finitely presented $R$-algebras $A$ and all finitely generated nilpotent ideals $N\subseteq A$,
    and all squares like below, there is a unique lift:
    \begin{center}
      \begin{tikzcd}
        \Spec (A/N)\ar[r]\ar[d,"\iota",swap] & X\ar[d,"f"] \\
        \Spec A \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
    -- where $\iota:\Spec (A/N)\to \Spec A$ is induced by the quotient map.
  \item A map $f:X\to Y$ of schemes is \notion{étale}, if it is formally étale.
  \end{enumerate}
\end{definition}

Another way to phrase our definition of formally étale maps would be to say,
that they are the maps with the right lifting property (\cite{modalities}[definition 1.45]) with respect to ``left`` maps of the form $\Spec (A/N)\to \Spec A$.
We will use some well known, general closure properties of left maps, starting with closure under composition:

\begin{lemma}%
\label{decomposition-nilpotent}
For $A$ an algebra and $N$ a nilpotent ideal in $A$, the map:
\[A
\to A/N
\] 
can be factored as maps of the form:
\[
B\to B/(b)
\]
where $b:B$ is such that $b^2=0$.
\end{lemma}

\begin{proof}
TODO
\end{proof}

\begin{lemma}
\label{equivalence-etale}
Having the right lifting property against the following class of maps is equivalent:
\begin{enumerate}[(i)]
\item Maps of the form $\Spec(A/N)\to \Spec(A)$ for $A$ f.g. algebra and $N$ a nilpotent ideal.
\item Maps of the form $P\to 1$ for $P$ a closed dense proposition.
\item Closed dense embeddings of types.
\item Maps of the form $(\epsilon=0)\to 1$ for $\epsilon:R$ such that $\epsilon^2=0$.
\item Maps of the form $\Spec(A/(a)) \to \Spec(A)$ for $A$ f.g. algebra and $a:A$ such that $a^2=0$.
\end{enumerate}
\end{lemma}

\begin{proof}
(i) implies (ii) because closed dense proposition are of the form $\Spec(R/N)$ for $N$ a nilpotent ideal.

(ii) implies (iii) because of \cref{pointwise-lift-is-enough}.

(iii) implies (iv) because $\epsilon=0$ is closed dense when $\epsilon$ is nilpotent.

(iv) implies (v) because of \cref{pointwise-lift-is-enough}, as the fiber of $\Spec(A/(a)) \to \Spec(A)$ over $x$ is $a(x)=0$.

(v) implies (i) because of \cref{decomposition-nilpotent}.
\end{proof}

\begin{lemma}
A map is formally étale if and only if all its fibers are formally étale.
\end{lemma}

\begin{proof}
By \cref{lifting-defined-fiberwise} and the characterisation (ii) from the previous lemma.
\end{proof}

From (ii) we even get that being formally étale is a lex modality, so we have the following:

\begin{proposition}
We have the following stability results:
\begin{itemize}
\item If $X$ is any type and for all $x:X$ we have a formally étale type $Y_x$, then:
\[\prod_{x:X}Y_x\]
is formally étale. 
\item  If $X$ is formally étale and for all $x:X$ we have a formally étale type $Y_x$, then:
\[\sum_{x:X}Y_x\]
is formally étale. 
\item If $X$ is formally étale then for all $x,y : X$ the type $x=y$ is formally étale.
\item The type of formally étale types is formally étale.
\end{itemize}
\end{proposition}

\begin{lemma}%
  \label{nilpotent-ideal-not-not-dense}
  Let $A$ be a finitely presented $R$-algebra and $N\subseteq A$ be finitely generated nilpotent.
  Then for $V\colonequiv \Spec (A/N)\subseteq \Spec A$ the following holds:
  \begin{enumerate}[(a)]
  \item For all $x:\Spec A$, $\neg\neg V(x)$.
  \item If $V=\emptyset$, then $\Spec A=\emptyset$.
  \end{enumerate}
\end{lemma}

\begin{proof}
  \begin{enumerate}[(a)]
  \item
    Let $x : \Spec A$ be given.
    The generators $n_1,\dots,n_l$ of $N$ are nilpotent functions,
    so in particular the elements $n_1(x), \dots, n_l(x)$ of $R$
    are not not zero.
    This means precisely $\neg\neg V(x)$.
  \item Assume $V=\emptyset$ and $x:\Spec A$.
        We want to show the $\neg\neg$-stable proposition $\emptyset$,
        so we can assume $V(x)$, which is a contradiction.
  \end{enumerate}
\end{proof}

\begin{proposition}%
  Let $P$ be a $\neg\neg$-stable proposition,
  then $P\to 1$ is formally étale.
\end{proposition}

\begin{proof}
  Direct application of \cref{nilpotent-ideal-not-not-dense}.
\end{proof}

\begin{proposition}%
  The map $\Bool\to 1$ is étale.
\end{proposition}

\begin{proof}
  We have to extend maps $f:\Spec (A/(a))\to \Bool$, with $a^2=0$.
  Since $\Bool\subseteq R$, the map $f$ yields an element $f:A/(a)$
  and we have a lift $\tilde{f}:A$ with $f=\tilde{f}+ab$.
  By \cref{nilpotent-ideal-not-not-dense},
  we have for any $x:\Spec A$, that $\neg\neg(\tilde{f}(x)=0)$ or $\neg\neg(\tilde{f}(x)=1)$.

  By Z-choice or computation, we find a $n:\N$,
  such that $\tilde{f}^n(x)=0$ or $\neg\neg(\tilde{f}^n(x)=1)$.
  With the map $1-\_:R\to R$, we can achieve the same for $1$.
\end{proof}

\begin{proposition}%
	\label{decidable-of-tangent}
	Let $X$ be an affine scheme and $a : X$ a point. Suppose the tangent space
	$T_a X$ has a unique point. Then for any $b : X$, equality $a = b$ is decidable.
\end{proposition}

\begin{proof}
	Given that $T_a X = \{0\}$, we also have $T^\star_a X = \mm_a / \mm_a^2 = 0$
	by \cref{maximal-cotangent}.
	So $\mm_a^2 = \mm_a$. By \cite[Lemma II.4.6]{lombardi-quitte}
	(proved using Nakayama's lemms, or the determinant trick), $\mm_a$ is generated
	by a single idempotent $e$ of $A$. We have $e(b)$ idempotent in $R$,
	so since $R$ is local it is either 0 or 1. We have $e(a) = 0$, so if $e(b) = 1$
	we have $a \ne b$. If $e(b) = 0$, then $a = b$ since $b$ is in the order 0
	neighborhood of $a$.
\end{proof}

\begin{proposition}%
	Let $X$ be a separated \'{e}tale scheme. Then $X$ has decidable equality.
\end{proposition}

\begin{proof}
	Let $a, b : X$. Since $X$ is separated, $a = b$ is closed.
	We claim it is also open.
	To see this, pick an affine open neighbourhood $U$ of $a$.
	Now $a = b$ is equivalent to $(b \in U) \wedge (a = b)$.
	Since open propositions are closed under $\Sigma$,
	it suffices to show that $a = b$ is open assuming $b \in U$.
	In this case we can apply \cref{decidable-of-tangent}.
\end{proof}

\begin{proposition}% TODO: put this in context, maybe deduce the above from this
	Let $P$ be a closed, $\neg \neg$-stable proposition. Then $P$ is decidable.
\end{proposition}
\begin{proof}
	Let $P$ be the proposition $I = 0$ where $I$ is a finitely generated ideal of $R$.
	We claim $(I^2 = 0) \to (I = 0)$. Indeed, if $I^2 = 0$, then no element of $I$
	can be invertible, so $I$ is not not zero, and since $P$ is $\neg \neg$-stable,
	$I = 0$. Hence $I$ is
	generated by a single idempotent $e$ of $R$.
	Since $R$ is local, $e$ is either $0$ or $1$. Since $P$ is equivalent to $e = 0$,
	$P$ is decidable.
\end{proof}

\subsection{Formally unramified maps}

\begin{definition}
For any types $X,Y$, a map $f:X\to Y$ is called formally unramified if for any closed proposition $P$ such that $\neg\neg P$ the following square has at most one lift:
 \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
\end{definition}

\begin{definition}
A map $f:X\to Y$ is unramified if $X$ and $Y$ are schemes and $f$ is formally unramified.
\end{definition}

It is clear that formally étale maps are formally unramified. As usual a type $X$ is called formally unramified if the map from $X$ to $1$ is unramified, and a map is formally unramified if and only if all its fibers are formally unramified.

\begin{lemma}
\label{equivalence-unramified}
Having at most one lift against the following class of maps is equivalent:
\begin{enumerate}[(i)]
\item Maps of the form $\Spec(A/N)\to \Spec(A)$ for $A$ f.g. algebra and $N$ a nilpotent ideal.
\item Maps of the form $P\to 1$ for $P$ a closed dense proposition.
\item Closed dense embeddings of types.
\item Maps of the form $(\epsilon=0)\to 1$ for $\epsilon:R$ such that $\epsilon^2=0$.
\item Maps of the form $\Spec(A/(a)) \to \Spec(A)$ for $A$ f.g. algebra and $a:A$ such that $a^2=0$.
\end{enumerate}
\end{lemma}

\begin{proof}
Same as \cref{equivalence-etale}.
\end{proof}

\begin{lemma}
A map is formally unramified if and only if all its fibers are formally unramified.
\end{lemma}

\begin{proof}
By \cref{lifting-defined-fiberwise} and the characterisation (ii) from the previous lemma.
\end{proof}

\begin{lemma}
A type $X$ is formally unramified if and only if for any $x,y:X$ the type $x=y$ is formally étale.
\end{lemma}
\begin{proof}
A type $X$ is formally unramified iff for any closed dense proposition $P$ the fibers of the canonical map in:
\[X\to X^P\]
are propositions. This is equivalent to the induced maps in:
\[(x=y)\to (x=y)^P\]
being equivalences for all $x,y:X$, i.e. all types $x=y$ being formally étale.
\end{proof}

In the langage of modalities, this means that formally unramified types are precisely formally étale-separated types. So being formally unramified is a (non-lex) modality, so that:

\begin{proposition}
We have the following stability results:
\begin{itemize}
\item If $X$ is any type and for all $x:X$ we have a formally unramified type $Y_x$, then:
\[\prod_{x:X}Y_x\]
is formally unramified. 
\item  If $X$ is formally unramified and for all $x:X$ we have a formally unramified type $Y_x$, then:
\[\sum_{x:X}Y_x\]
is formally unramified.
\end{itemize}
\end{proposition}

\subsection{Unramified schemes}

\begin{proposition}
A scheme $X$ is unramified if and only if any of the following propositions hold:
  \begin{enumerate}[(i)]
  \item For all $x,y:X$, the proposition $x=y$ is open.
  \item For all $x,y:X$, the proposition $x=y$ is $\neg\neg$-stable.
  \item For all $x:X$, we have $T_x(X)=0$.
  \item For all infinitesimal pointed type $(D,*)$ (meaning that for all $x:D$ we have $\neg\neg(x=*)$), any map from $D$ to $X$ is constant.
  \end{enumerate}
\end{proposition}

\begin{proof}
First we prove that the four propositions are equivalent:

(i) implies (ii) because open propositions are $\neg\neg$-stable.

(ii) implies (iv) because for any $f:D\to X$ and $x:D$ we have $\neg\neg(x=*)$ so that $\neg\neg(f(x)=f(*))$ and finally $f(x)=f(*)$.

(iv) implies (iii) by taking $D=\mathbb{D}(1)$.

(iii) implies (i) because for any $x:X$ there an open affine $U$ such that $x\in U$. Then $x=y$ is equivalent to $(y\in U)\land x=_U y$, but $x=_Uy$ is decidable by \cref{decidable-of-tangent} and open propositions are stable by $\Sigma$.

Now we check they are equivalent to being unramified:

(ii) implies unramified, indeed we need to check that for $x,y:X$ and $P$ closed dense such that $P\to x=y$, we have $x=y$. But $\neg\neg P$ so that $\neg\neg(x=y)$, and by (ii) we have $x=y$.

Unramified implies (iii) because it implies having at most one lifting against any closed dense subtype, so that by considering $1\subset \mathbb{D}(1)$ it implies having at most one tangent vector.
\end{proof}

\begin{example}
Any proposition is formally unramified, so any embedding of types is formally unramified.

Finite sets are unramified, as their identity types are decidable and therefore $\neg\neg$-stable.

The affine line $\A^1$ is not unramified, as its identity types are not $\neg\neg$-stable. Same for $\mathbb{D}(1)$.
\end{example}

\begin{lemma}
\label{kernel-is-tangent-of-fibers}
For any map $f:X\to Y$ and $x:X$, we have that:
\[
\mathrm{Ker}(df_x) = T_{(x,\refl_{f(x)})}(\mathrm{fib}_f(f(x)))
\]
\end{lemma}
\begin{proof}
This holds because:
\[
(\mathrm{fib}_f(f(x)),(x,\refl_{f(x)}))
\]
is the pullback of:
\[
(X,x) \to (Y,f(y)) \leftarrow (1,*)
\]
in pointed types, applied using $(\mathbb{D}(1),0)$.
\end{proof}

\begin{proposition}
A map between schemes is unramified if and only if its differentials are injective. 
\end{proposition}
\begin{proof}
The map $df_x$ is injective if and only if its kernel is $0$. By \cref{kernel-is-tangent-of-fibers}, this means that $df_x$ is injective for all $x:X$ if and only if:
\[
\prod_{x:X}T_{(x,\refl_{f(x)})}(\mathrm{fib}_f(f(x)))=0
\]
On the other hand having fibers with trivial tangent space is equivalent to:
\[
\prod_{y:Y}\prod_{x:X}\prod_{p:f(x)=y} T_{(x,p)}(\mathrm{fib}_f(y)) = 0
\]
Both are equivalent by path elimination on $p$.
\end{proof}

\subsection{Smooth maps}

\begin{definition}
A morphism $f:X\to Y$ is formally smooth for any closed dense proposition $P$ the square:
 \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
merely has a lift.
\end{definition}

\begin{remark}
The usual definition for formally smooth is to ask for lifting in:
 \begin{center}
      \begin{tikzcd}
        \Spec(A/N)\ar[r]\ar[d] & X\ar[d,"f"] \\
       \Spec(A) \ar[r]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
    with $N$ nilpotent. Note that here since we do not have: 
\[
\prod_{x:A} ||B(x)|| \to ||\prod_{x:A}B(x)||
\]
we do not have a direct analogue to \cref{equivalence-etale} or \cref{equivalence-unramified}.
\end{remark}

Our definition of formal smoothness is convenient because it implies:

\begin{lemma}
A map is formally smooth if and only if its fibers are formally smooth.
\end{lemma}
\begin{proof}
The type of filler for:
 \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & X\ar[d,"f"] \\
       1 \ar[r,"y"]\ar[ru,dashed] & Y
      \end{tikzcd}
    \end{center}
   is equivalent to the type of filler for:
    \begin{center}
      \begin{tikzcd}
        P\ar[r]\ar[d] & \mathrm{fib}_f(y) \\
       1 \ar[ru,dashed] & 
      \end{tikzcd}
    \end{center}
\end{proof}

\begin{remark}
Formally smooth and formally unramified implies formally étale.
\end{remark}

We give a few examples and counter-examples:

\begin{lemma}
The scheme $\A^n$ is smooth for any $n$.
\end{lemma}

\begin{proof}
We need to prove that there merely exists a dotted lift in any:
 \begin{center}
      \begin{tikzcd}
        R/N & R[X_1,\cdots,X_n]\ar[l]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center}
    It is enough to choose a lift for each $X_i$.
\end{proof}

\begin{lemma}
A type covered by finitely many formally smooth subtype is formally smooth.
\end{lemma}
\begin{proof}
We assume $P_1,\cdots,P_n:X\to \Prop$ covering $X$, i.e. for all $x:X$ we have:
\[
\prod_{x:X}P_1(x)\lor\cdots\lor P_n(x)
\]
such that $\Sigma_{x:X}P_i(x)$ is formally smooth for all $i$.

Assume given:
   \begin{center}
      \begin{tikzcd}
        P\ar[r,"\phi"]\ar[d] &X \\
       1 \ar[ru,dashed] & 
      \end{tikzcd}
    \end{center}
   then we have:
   \[\prod_{p:P} P_1(\phi(p))\lor\cdots\lor P_n(\phi(p))\]
   so that for some $i$ we have:
      \[\prod_{p:P} P_i(\phi(p))\]
as $P$ is closed. So $\phi$ factors through $\Sigma_{x:X}P_i(x)$ which is formally smooth and we can conclude. %Then we can simply lift in $P_i$, which is assumed    
\end{proof}

\begin{corollary}
The scheme $\mathbb{P}^n$ is smooth for any $n$.
\end{corollary}

\begin{lemma}
The scheme $\D(1)$ is not smooth.
\end{lemma}

\begin{proof}
If it were smooth, for any $\epsilon$ with $\epsilon^3=0$ we would be able to prove $\epsilon^2=0$. Indeed would merely is a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        R/(\epsilon^2)& R[X]/(X^2)\ar[l,"\epsilon"]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center}
    that is a $r:R$ such that $(\epsilon+r\epsilon^2)^2=0$. Then $\epsilon^2=0$.
\end{proof}

\begin{lemma}
The scheme $\Spec(R[X,Y]/(XY))$ is not smooth.
\end{lemma}

\begin{proof}
If it were smooth, for any $\epsilon$ with $\epsilon^3=0$ we would be able to prove $\epsilon^2=0$. Indeed would merely is a dotted lift in:
 \begin{center}
      \begin{tikzcd}
        R/(\epsilon^2) & R[X,Y]/(XY)\ar[l]\ar[ld,dashed] \\
        R\ar[u] & 
      \end{tikzcd}
    \end{center}
    where the top map send both $X$ and $Y$ to $\epsilon$. Then we have $r,r':R$ such that $(\epsilon+r\epsilon^2)(\epsilon+r'\epsilon^2)=0$ so that $\epsilon^2=0$. %This can't be done.
\end{proof}

\begin{lemma}
The map:
\[
p:\Spec(R[X,Y]/(XY))\to \A^1
\] 
corresponding to the map in:
\[
R[X,Y]/(XY) \to R[X]
\]
sending $X$ to $X$ and $Y$ to $0$ is not smooth.
\end{lemma}

\begin{proof}
If it were smooth all its fibers would be smooth, i.e. for all $z:R$ the scheme $\Spec(R[X]/(zX))$ would be smooth. This would imply that for any $\epsilon:R$ such that $\epsilon^2=0$ we merely have a dotted lift to:
 \begin{center}
      \begin{tikzcd}
        R/\epsilon & R[X]/(\epsilon X)\ar[l]\ar[ld,dashed] \\
        R \ar[u]& 
      \end{tikzcd}
    \end{center} 
    where the top map send $X$ to $1$. Such a lift gives an $r:R$ such that $\epsilon(1+r\epsilon)=0$, so that $\epsilon=0$.
\end{proof}

I think in the traditional setting this map has smooth fibers, but not here. Now we give stability properties for formally smooth types.

\begin{proposition}
\label{smoothSurjective}
The image of a formally smooth type by any map is formally smooth.
\end{proposition}
\begin{proof}
We assume $X$ formally smooth and $p:X\to Y$ surjective. Then for any $P$ closed dense and diagram:
 \begin{center}
      \begin{tikzcd}
      P \ar[rd,dotted]\ar[d]\ar[r]& Y\\
      1 \ar[r,dotted,swap,"x"]& X\ar[u,swap,"p"]
      \end{tikzcd}
    \end{center} 
    by choice for closed propositions we merely get the dotted diagonal, and since $X$ is formally smooth we get the dotted $x$, and then $p(x)$ gives a lift.
\end{proof}

\begin{lemma}
If $X$ is a type satifying choice and for all $x:X$ we have a formally smooth type $Y_x$, then:
\[\prod_{x:X}Y_x\]
is formally smooth.
\end{lemma}

So for example formally smooth types are stable by finite products. 

\begin{lemma}
If $X$ is a formally smooth type and for all $x:X$ we have a formally smooth type $Y_x$, then:
\[\sum_{x:X}Y_x\]
is formally smooth.
\end{lemma}

Formally smooth types are not stable by identity types (e.g. identity types in $\A^1$ are not smooth, otherwise they would be closed and étale, i.e. decidable).

\subsection{Etale replacement of schemes}

We write $\mathrm{Cld}$ for the type of closed dense proposition, i.e. closed propositions $P$ such that $\neg\neg P$.

\begin{lemma}
Closed dense propositions are closed under $\Sigma$.
\end{lemma}
\begin{proof}
We know that closed proposition are closed under $\Sigma$, so we just need to check that when $\neg\neg P$ and for all $x:P$ we have $\neg\neg Q(x)$ then $\neg\neg(\Sigma_{x:P}Q(x))$. This is easy.
\end{proof}

\begin{lemma}
The formally étale replacement of a proposition $P$ is:
\[\exists (Q :\mathrm{Cld}). P^Q\]
\end{lemma}

\begin{proof}
First we check that:
\[\exists(Q :\mathrm{Cld}). P^Q\]
is étale. Assume $R$ closed dense such that: 
\[R\to \exists(Q :\mathrm{Cld}). P^Q\]
Then since closed propositions satisfy choice and we try to prove a proposition, we can assume:
\[R\to \Sigma_{Q :\mathrm{Cld}} P^Q\]
i.e. we have $Q : R\to \mathrm{Cld}$ such that:
\[\prod_{x:R} P^{Q(x)}\]
Then $\Sigma_{x:R}Q(x)$ is closed dense and it implies $P$ so:
\[\exists(Q :\mathrm{Cld}). P^Q\]
holds.

We know that the formally étale replacement of a proposition is a proposition, so to conclude it is enough to prove that:
\[\exists(Q :\mathrm{Cld}). P^Q\]
is initial among formally étale propositions implied by $P$. Assume $U$ a formally étale proposition such that $P\to U$, we want to prove that:
\[(\exists(Q :\mathrm{Cld}). P^Q)\to U\]
Since we want to prove a proposition we can assume $Q$ closed dense such that $P^Q$, then $U^Q$ holds and this implies $U$ since $U$ is formally étale.
\end{proof}

This can be generalised to sets:

\begin{proposition}
\label{etaleReplacementUnramified}
Let $X$ be a formally unramified set, then the formally étale replacement of $X$ is:
\[\mathrm{colim}_{Q:\mathrm{Cld}} X^Q\]
\end{proposition}

\begin{proof}
For any closed dense proposition $P$ and $Q$ such that $P\to Q$, we have that the fibers of:
\[P\to Q\]
are simply $P$ so that this is a closed dense embedding and the map:
\[X^Q\to X^P\]
is an embedding as $X$ is unramified. So we have that:
\[\mathrm{colim}_{Q:\mathrm{Cld}} X^Q\]
is a filtered colimit of embeddings. Now we have the following:
\begin{itemize}
\item The colimit is formally unramified, i.e. its identity types are étale. Since it is a filtered colimit of embeddings, it is enough to prove that identity types in $X^Q$ are étale for any closed dense $Q$, which holds because $X$ is unramified.
\item The colimit is formally smooth. By \cref{smoothSurjective} it is enough to show that:
\[ \Sigma_{Q:\mathrm{Cld}} X^Q \]
is formally smooth. But this follow from stability of closed dense propositions by dependent sum.
\item Now we show that the map:
\[X \to \mathrm{colim}_{Q:\mathrm{Cld}} X^Q\]
is étale-connected. Since we have a filitered colimit of embeddings, the fiber over $\phi:X^Q$ is simply the type of filler for:
  \begin{center}
      \begin{tikzcd}
      Q \ar[r,"\phi"]\ar[d]& X\\
      1 & 
      \end{tikzcd}
    \end{center}
    This type is a proposition since $X$ is unramified, so its formally étale replacement is a proposition and we just need to check that it is inhabited. But under the formally étale modality we can assume $Q$ and then we have a lift.
\end{itemize}
\end{proof}

It should be noted that the fact, that $X$ is a set, was only used to define the colimit in the previous proposition,
which extends readily to all the cases where the colimit can be defined in HoTT.

\begin{proposition}
\label{unramifiedReplacementEtaleForSmooth}
Let $X$ be formally smooth, then the formally unramified replacement of $X$ is formally étale.
\end{proposition}

The converse does not hold, e.g.\ by considering an infinitesimal variety.

\begin{proof}
The map from $X$ to its formally unramified replacement is surjective by \cref{separatedLocalisationIsQuotient}, so the formally unramified replacement is formally smooth by \cref{smoothSurjective}.
\end{proof}

Now we focus on étale replacement for schemes.

\begin{lemma}
Let $P$ be a closed proposition, then the étale replacement of $P$ is $\neg\neg P$.
\end{lemma}

\begin{proof}
We have that $\neg\neg P$ is étale because it is $\neg\neg$-stable. It is initial among maps from $P$ to étale types because $P\to \neg\neg P$ is a closed dense embedding.
\end{proof}

\begin{lemma}
Let $P$ be an identity types in a scheme, then the étale replacement of $P$ is $\neg\neg P$.
\end{lemma}

\begin{proof}
An identity type in a scheme is of the form:
\[\Sigma_{x:U}C(x)\]
for $U$ open and $C(x)$ closed for all $x:U$. Then:
\[\neg\neg(\Sigma_{x:U}C(x)) \to \Sigma_{x:U}\neg\neg C(x)\]
because $\neg\neg U \to U$ and we can conclude because $\neg\neg C(x)$ is the étale replacement of $C(x)$.
\end{proof}

\begin{corollary}
\label{unramifiedReplacementScheme}
The unramified replacement of a scheme $X$ is the quotient of $X$ by the relation $\neg\neg(x=_Xy)$.
\end{corollary} 

\begin{proof}
By \cref{separatedLocalisationIsQuotient} combined with the previous lemma.
\end{proof}

By combining \cref{etaleReplacementUnramified} and \cref{unramifiedReplacementScheme} we can compute the étale replacement of any scheme. By \cref{unramifiedReplacementEtaleForSmooth} the second step is not necessary for smooth scheme. 

\begin{example}
The étale replacement of $\A^n$ is $\tilde{R}^n$ where $\tilde{R}$ is the quotient of $R$ by its nilradical.
\end{example}

The étale replacement of $\mathbb{P}^n$ should be $\mathbb{P}_{\tilde{R}}^n$ but I did not make this precise.

\subsection{Smooth morphisms between schemes}

\begin{lemma}\label{lifting-is-torsor}
Let $X$ be a scheme and $\epsilon:R$ such that $\epsilon^2=0$. Then the type of liftings of:
 \begin{center}
      \begin{tikzcd}
      \epsilon=0 \ar[d]\ar[r,"\phi"]& X\\
      1 & 
      \end{tikzcd}
    \end{center} 
is an $M$-pseudotorsor where:
\[M = \Hom_{R/\epsilon}\big(\prod_{p:\epsilon=0}T^\star_{\phi(p)}(X),(\epsilon)\big)\]
\end{lemma}
\begin{proof}
TODO
\end{proof}

\begin{lemma}\label{M-is-wqc}
The $R$-module $M$ from the previous lemma is wqc.
\end{lemma}

\begin{proof}
For any $p:\epsilon=0$ we have that $T^\star_{\phi(p)}(X)$ is a finitely presented $R$-module, so that:
\[N = \prod_{p:\epsilon=0}T^\star_{\phi(p)}(X)\]
is a finitely presented $R/\epsilon$-module. Assume a presentation:
\[
(R/\epsilon)^m \to (R/\epsilon)^n\to N\to 0
\]
then we have an exact sequence of $R$-modules:
\[
0\to \Hom_{R/\epsilon}(N,(\epsilon)) \to (\epsilon)^n\to (\epsilon)^m
\]
but $(\epsilon)$ is wqc so that $\Hom_{R/\epsilon}(N,(\epsilon))$ is the kernel of a map between wqc $R$-modules and it is wqc.
\end{proof}

\begin{proposition}
Let $p:X\to Y$ be a map which fibers are schemes. Then $p$ merely having lifts against the following classes of maps is equivalent:
\begin{enumerate}[(i)]
\item The maps $\epsilon=0\to 1$ where $\epsilon^2=0$.
\item The maps $P\to 1$ where $P$ is closed dense (i.e. $p$ being formally smooth).
\item The maps $\Spec(A/a)\to \Spec(A)$ where $A$ fp $R$-algebra and $a^2=0$.
\item The maps $\Spec(A/N)\to \Spec(A)$ where $A$ fp $R$-algebra and $N$ fg nilpotent ideal.
\end{enumerate}
\end{proposition}

\begin{proof}
It is enough to prove that (i) implies (iii), as any map in (iv) is a composite of maps in (iii). Assume a diagram:
 \begin{center}
      \begin{tikzcd}
      \Spec(A/a) \ar[d]\ar[r]& X\ar[d,"p"]\\
      \Spec(A) \ar[r] & Y
      \end{tikzcd}
    \end{center} 
    with $a^2=0$, we try to merely find a lift. By \cref{lifting-is-torsor}, we know that the type of lifts over $x:\Spec(A)$ is an $M_x$-pseudotorsor. By hypothesis (i) this is in fact an $M_x$-torsor. Mere existence of a lift for the diagram is then precisely a mere section of the dependent torsor $(x:\Spec(A))\mapsto M_x$, i.e. a proof that it is merely trivial. But $M_x$ is wqc by \cref{M-is-wqc} so that $H^1(\Spec(A),M)=0$ by \cite{draft}[Theorem 8.3.6] and any $M$-torsor is merely trivial, meaning we merely have a lift.
\end{proof}


\subsection{Hensel lifting}

\begin{lemma}
  Let $f : \A^1 \to \A^1$ and
  $p : \A^1$ with $f(p)$ nilpotent and
  $f'(p)$ invertible.
  Then there exists $q : \A^1$
  with $\lnot \lnot (q = p)$
  and $f(q) = 0$.
\end{lemma}

\begin{proof}
  Let $f(p)^n = 0$, induct on $n$.
  If $n \leq 1$ we are done.
  Otherwise, let $p' = p - f(p)/f'(p)$.
  Then $\lnot \lnot (p' = p)$ and we have
  \[ f(p')
     = f(p) - f'(p) (f(p)/f'(p)) + r (f(p)/f'(p))^2
     = r (f(p)/f'(p))^2 \]
  for some $r : R$
  by Taylor expansion.
  Thus ${f(p')}^m = 0$ for $2m \geq n$
  and we are done by inductive hypothesis.
\end{proof}
