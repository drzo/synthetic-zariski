This section contains some preliminary works on sheaves in the context of synthetic algebraic geometry. I (Hugo) am not sure it should go here. It is very similar to Section 10 of fundamentals.

For now, I work in the topos of presheaf on the Zariski site, meaning that I use a (non-local) ring $R$ with synthetic coherence:
\[ A \simeq R^{\Spec(A)} \]
for $A$ f.p. $R$-algebra, as well as global choice for affine schemes.

\subsection{Preliminaries}

\begin{lemma}\label{affine-closed-sigma}
Affine schemes are closed by dependent sums.
\end{lemma}

\begin{proof}
Assume given $B_x$ a f.p. $R$ algebra depending on $x:\Spec(A)$. Using boundedness and choice, as well as the stability of affine schemes by binary sums, we may assume that we merely have:
\[B_x = R[X_1,\cdots,X_n]/(P_1(x),\cdots, P_m(x))\]
where the coefficients of $P_1,\cdots,P_m$ depends on $x:\Spec(A)$. By synthetic quasi-coherence this gives an f.p. $R$ algebra:
\[B = A[X_1,\cdots,X_n]/(P_1,\cdots, P_m)\]
Then we have that:
\[\Spec(B) = \sum_{x:\Spec(A)} \Spec(B_x)\]
as the canonical map:
\[\Spec(B) \to \Spec(A)\]
has fiber $\Spec(B_x)$ over $x:\Spec(A)$.
\end{proof}

\begin{lemma}\label{sum-affine-closed-sigma}
Finite sums of affine schemes are closed by dependent sums.
\end{lemma}

\begin{proof}
It is enough to prove this for an affine scheme $\Spec(A)$ and a family $B_x$ of finite sum of affine schemes indexed by $x:\Spec(A)$.

Using boundedness and choice for $\Spec(A)$ we merely get a map:
\[f:\Spec(A) \to \{0,\cdots,n\}\]
sending $x$ to the number of summed affine scheme in $B_x$. By considering:
\[\Spec(A) = f^{-1}(0) + \cdots + f^{-1}(n)\]
we see that it is enough to prove the result when $f$ is constant, and to treat this case it is enough to prove the result for a family of affine schemes over $\Spec(A)$. This is \cref{affine-closed-sigma}.
\end{proof}

\subsection{Definitions of sheaves}

\begin{definition}
A pre-topology is a class $T$ of finite sums of affine schemes. It is called a topology if $T$ is closed under dependent sums and $1\in T$.
\end{definition}

\begin{remark}
We need to use finite sums of affine schemes rather than just affine schemes to accommodate the fact that $\bot$ is not an affine scheme when $0=1$ in $R$. Note that such a finite sum has choice, as it is either empty or an affine scheme.
\end{remark}

Intuitively, an affine scheme is in $T$ if it covers the point. There is an obvious topology generated by any pre-topology

\begin{remark}
For the notion of topology to make sense we need finite sums of affine scheme to be closed under dependent sums, as shown in \cref{sum-affine-closed-sigma}.
\end{remark}

\begin{definition}
Let $T$ be a pretopology. A map is a $T$-cover if its fibers are in $T$.
\end{definition} 

If $T$ is a topology, $T$-covers are stable by composition.

\begin{definition}
Let $T$ be a pretopology. A type is a $T$-sheaf if it is $\propTrunc{X}$-local for all $X\in T$. We write $L_T$ for the $T$-sheafification.
\end{definition}

\begin{remark}
Being a $T$-sheaf is a lex modality, so that $T$-sheaves are stable by dependent sum, identity types and product over arbitrary types, and the type of $T$-sheaves is a $T$-sheaf. 
\end{remark}

This means that HoTT can be interpreted into $T$-sheaf, by replacing the universe of types by the universe of $T$-sheaves. This interpretation can be extended to propositional truncation by sending the propositional truncation of a $T$-sheaf $X$ to:
\[L_T\propTrunc{X}\]

\subsection{$T$-sheaves agree with the usual sheaves}

\begin{lemma}\label{prop-trunc-into-set}
For $X$ a set and any type $A$, we have that the canonical map:
\[X^{\propTrunc{A}} \to \sum_{f:X^A} \prod_{a,b:A} f(a)=f(b)\]
is an equivalence.
\end{lemma}

\begin{proof}
To define the map the other way, assume given such an $f:A\to X$. We consider the family of propositions:
\[ \_:\propTrunc{A} \mapsto \sum_{x:X} \prod_{a:A} f(a)=_X x\]

To show that it has a section it is enough to prove it has a section for any $a:A$, which is clear using $f(a):X$. We omit the proof that these maps are inverse to each other.
\end{proof}

Next lemma prove that a type $X$ is a $T$-sheaf iff it is a sheaf in the usual sense, at least when $X$ is a set.

\begin{lemma}\label{set-sheaves-condition}
Let $T$ be a pre-topology, then a set $X$ is a $T$-sheaf if and only if for any $T$-cover:
\[A\to B\]
we have that the canonical map: 
\[X^B\to \mathrm{lim} (X^A \rightrightarrows X^{A\times_BA})\]
is an equivalence.
\end{lemma}

\begin{proof}
Since dependent sums commute with limits, we can reason fiberwise over $B$ and then the given condition is equivalent to the canonical maps:
\[X\to \mathrm{lim} (X^A \rightrightarrows X^{A\times A})\]
being an equivalence for all $A$ in $T$. 

To conclude that this condition is equivalent to being a $T$-sheaf we just need to prove that the canonical maps:
\[X^{\propTrunc{A}} \to \mathrm{lim} (X^A \rightrightarrows X^{A\times A})\]
are equivalences, but this is \cref{prop-trunc-into-set}.
\end{proof}

This could in principle be extended to $n$-types for any $n$, given enough patience to write down all the coherences. There is probably a way using the approximation for propositional truncation using iterated join.

\subsection{Sheaf models compared to the presheaf model}

Next lemma says that the interpretation of $\propTrunc{X}$ into $T$-sheaves holds for all $X\in T$.

\begin{lemma}\label{sheaves-inhabited}
Let $T$ be a pre-topology, then for any $X\in T$, we have that:
\[L_T\propTrunc{X}\]
\end{lemma}

\begin{proof}
We have that: 
\[\propTrunc{X}\to L_T\propTrunc{X}\]
and that $L_T\propTrunc{X}$ is $\propTrunc{X}$-local, so $L_T\propTrunc{X}$ holds.
\end{proof}

\begin{definition}
A pre-topology $T$ is called subcanonical if $R$ is a $T$-sheaf.
\end{definition}

\begin{lemma}\label{sheaves-quasi-coherent}
If $T$ is a subcanonical pre-topology, then the intepretation of synthetic quasi-coherence holds in $T$-sheaves.
\end{lemma}

\begin{proof}
Since $R$ is a $T$-sheaf, so is any affine scheme, and by synthetic quasi-coherence so is any f.p. $R$-algebra. Then the interpretation of synthetic quasi-coherence into $T$-sheaves is just the usual synthetic quasi coherence, which is assumed to hold.
\end{proof}

\begin{lemma}\label{sheaf-replacement-proposition}
If $T$ is a topology and $P$ is a proposition, then 
\[L_T(P) \simeq \exists X\in T.\ P^X\]
\end{lemma}

\begin{proof}
First we check that if: 
\[\exists X\in T.\ P^X\]
we have $L_T(P)$. Since the goal is a proposition (as modality preserves propositions), we can assume $X\in T$ such that $X\to P$. Then we have that: 
\[\propTrunc{X}\to P\to L_T(P)\] 
so that $L_T(P)$ holds as it is $\propTrunc{X}$-local.

Conversely we have that:
\[P \to \exists X\in T.\ P^X\] 
as $1\in T$ so it is enough to check that the proposition $\exists X\in T.\ P^X$ is $T$-local. Assume $Y\in T$ such that:
\[\propTrunc{Y} \to \exists X\in T.\ P^X\] 
then we have:
\[Y \to \exists X\in T.\ P^X\] 
and since $Y$ has choice we merely have:
\[Y \to \sum_{X\in T}\ P^X\] 
so that we merely have $X_y\in T$ depending on $y:Y$ such that:
\[(\sum_{y:Y}X_y) \to P\]
Since $T$ is closed by dependent sum we can conclude that:
\[\exists X\in T.\ P^X\] 
\end{proof}

\begin{definition}
We say that a type $X$ has $T$-local choice if for all $P(x)$ depending on $x:X$ with:
\[\prod_{x:X}\propTrunc{P(x)} \]
there merely exists a $T$-cover $f:Y\to X$ such that:
\[ \prod_{y:Y}P(f(y))\]
\end{definition}

Next lemma implies that when $T$ is a topology and $X$ has choice, the interpretation of $X$ having $T$-local choice holds in $T$-sheaves.

\begin{lemma}\label{sheaves-have-local-choice}
If $T$ is topology, for any type $X$ enjoying choice and $P(x)$ depending on $x:X$, if we have:
\[\prod_{x:X}L_T\propTrunc{P(x)}\]
then there merely exists a $T$-cover $f:Y\to X$ such that:
\[ \prod_{y:Y}P(f(y))\]
\end{lemma}

\begin{proof}
By \cref{sheaf-replacement-proposition} the hypothesis is equivalent to:
\[\prod_{x:X}\exists X\in T. P(x)^X\]
then $X$ has choice so we can conclude.
\end{proof}

We bundle all of this in one result:

\begin{theorem}\label{main-result-sheaves}
If $T$ is a subcanonical toplogy, then the interpretation of the following holds in $T$-sheaves:
\begin{enumerate}[(i)]
\item We have $\propTrunc{X}$ for all $X\in T$.
\item Synthetic quasi-coherence.
\item Any affine scheme has $T$-local choice.
\end{enumerate}
\end{theorem}

\begin{proof}
(i) is by \cref{sheaves-inhabited}.

(ii) is by \cref{sheaves-quasi-coherent}.

(iii) is by \cref{sheaves-have-local-choice}.
\end{proof}

\subsection{Zariski topology}

\begin{definition}
An affine scheme is in the Zariski pre-topology $Zar$ if it merely is of the following form:
\[\Spec(R_{f_1})+ \cdots +\Spec(R_{f_n})\]
for $f_1,\cdots, f_n:R$ with $(f_1,\cdots,f_n)=1$.
\end{definition}

\begin{lemma}
The Zariski pre-topology is a toplogy.
\end{lemma}

\begin{proof}
TODO, should use the fact that any map $\Spec(R_f)\to\N$ gives a partition of $R_f$ by a fundamental system of idempotents.
\end{proof}

\begin{lemma}
The Zariski topology is subcanonical.
\end{lemma}

\begin{proof}
Using \cref{set-sheaves-condition} we just need to prove that given $f_1,\cdots,f_n$ generating $R$, giving $x:R$ is equivalent to giving a family $x_i:R_{f_i}$ of pairwise compatible elements. 

TODO
\end{proof}

Now we can state the main theorem about Zariski-sheaves, namely that they model synthetic algebraic geometry.

\begin{theorem}
The interpretation of the following in Zariski-sheaves holds:
\begin{enumerate}[(i)]
\item The ring $R$ is local.
\item Synthetic quasi-coherence.
\item Any affine scheme has Zariski-local choice.
\end{enumerate}
\end{theorem}

\begin{proof}
By \cref{main-result-sheaves} it is enough to prove that:
\[\propTrunc{X}\]
for any $X$ in the Zariski topology implies that $R$ is local. 

If $0=1$ then the empty sum is in Zariski, which gives a contradiction. For any $f:R$ we have that:
\[\Spec(R_f)+\Spec(R_{1-f})\]
is in the Zariski topology so that:
\[\Spec(R_f) \lor \Spec(R_{1-f})\]
holds, meaning that $R$ is local.
\end{proof}

\subsection{Étale topology}

TODO

\begin{lemma}
Let $f:R[X]$ be a monic polynomial. Then $R$ is $\propTrunc{\Spec(R[X]/g)}$-local.
\end{lemma}

\begin{proof}
Using \cref{set-sheaves-condition} we just need to prove that the equaliser of:
\[R[X]/g \rightrightarrows R[X]/g \otimes R[X]/g\]
as $R$-algebras is $R$. But equaliser of algebras are just equalisers of modules, and since $g$ is monic we have:
\[R[X]/g \simeq R^n\]
as $R$-modules TODO
\end{proof}

